<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Athlete Combine Dashboard (Local)</title>
<!-- Libraries (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    :root{
      --bg:#0b0f17;
      --card:#121a27;
      --muted:#8aa0b6;
      --text:#e8f0ff;
      --line:#1e2a3c;
      --accent:#09a7d4;
      --accent2:#5471b7;
      --good:#3ddc97;
      --bad:#ff6b6b;
      --warn:#ffd166;
      --radius:16px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% 10%, rgba(9,167,212,.18), transparent 55%),
                 radial-gradient(1000px 700px at 80% 20%, rgba(84,113,183,.18), transparent 55%),
                 var(--bg); color:var(--text);}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,23,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 16px;}
    /* Keep header controls below the title (stable + no "pushed up" toolbar) */
    .title{display:flex;flex-direction:column;gap:12px;align-items:flex-start;justify-content:flex-start}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}

    .titleBar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;width:100%;}
    .topRightControls{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
    /* In Media View, only show Media toggle (hide other mode/load controls) */
    html.mediaView #toggleScout,
    html.mediaView #toggleCoach,
    html.mediaView #photosLabel,
    html.mediaView #csvLabel{display:none !important;}
    .row{display:grid;grid-template-columns: 420px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){ .row{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    .card .bd{padding:14px}
    .pill{
      font-size:12px; color: #d8ecff;
      border:1px solid rgba(9,167,212,.35);
      background: rgba(9,167,212,.12);
      padding:6px 10px;border-radius:999px;
      white-space:nowrap;
    }
    /* Admin view pill */
    .pill.pillAdmin{
      font-size:10px;
      padding:3px 10px;
      border-color: rgba(0,200,170,.55);
      background: rgba(0,200,170,.12);
      color:#e8fff8;
    }

    /* Public view indicator (subtle, small) */
    .pillPublic{
      font-size:10px;
      padding:0px 6px;
      letter-spacing:0.3px;
      border:1px solid rgba(255,209,102,.35);
      background: rgba(255,209,102,.12);
      color:#fff1c2;
      line-height:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
    }
.pillMedia{
      font-size:10px;
      padding:0px 6px;
      letter-spacing:0.3px;
      border:1px solid rgba(81,202,245,.22);
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      height:16px;
      background: rgba(81,202,245,.12);
      color:#d7f6ff;
    }

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;}

    .btn{
      appearance:none;border:1px solid rgba(9,167,212,.35);
      background: rgba(9,167,212,.12); color:var(--text);
      padding:9px 12px;border-radius:12px; cursor:pointer;
      font-weight:600; font-size:13px;
    }
    .btn:hover{filter:brightness(1.1)}
    .input{
      width:280px; max-width:100%;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      color:var(--text); outline:none;
    }
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .drop{
      border:1px dashed rgba(138,160,182,.45);
      border-radius:14px; padding:10px 12px;
      background: rgba(255,255,255,.02);
    }
    .drop strong{color:#cfe7ff}
    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{
      text-align:left; font-weight:700;
      padding:10px 10px; color:#cfe7ff;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background: rgba(18,26,39,.85); backdrop-filter: blur(10px);
      z-index:1;
    }
    tbody td{padding:10px 10px;border-bottom:1px solid rgba(30,42,60,.7); color:#dfeaff}
    tbody tr{cursor:pointer}
    tbody tr:hover{background: rgba(9,167,212,.08)}
    tbody tr.active{background: rgba(84,113,183,.16)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

    .kpis{display:grid;grid-template-columns: repeat(3, 1fr);gap:12px}
    @media (max-width: 980px){ .kpis{grid-template-columns:1fr} }
    .kpi{border:1px solid rgba(30,42,60,.9); border-radius:14px; padding:12px; background: rgba(255,255,255,.02)}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;font-weight:800;margin-top:6px}
    .kpi .meta{margin-top:6px;color:var(--muted);font-size:12px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .badge.good{border-color:rgba(61,220,151,.35); background: rgba(61,220,151,.1); color:#c9ffe8}
    .badge.bad{border-color:rgba(255,107,107,.35); background: rgba(255,107,107,.08); color:#ffd1d1}
    .badge.warn{border-color:rgba(255,209,102,.35); background: rgba(255,209,102,.1); color:#fff1c2}

    .twoCol{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;align-items:start}
    @media (max-width: 980px){ .twoCol{grid-template-columns:1fr} }

    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
canvas{width:100% !important; height:320px !important}
  
    /* --- Scout Mode (single-page layout switch) --- */
    #scoutPhotoBlock{display:none;}
    body.scoutMode #dashPhotoBlock{display:none !important;}
    body.scoutMode #scoutPhotoBlock{display:block !important;}

    /* Hide position controls/tooltip in Scout Mode */
    body.scoutMode #posTooltip{display:none !important;}
    body.scoutMode #posInfoBtn{display:none !important;}
    body.scoutMode #posSelect{display:none !important;}

    /* Save real estate in scout mode */
    body.scoutMode #twoColWrap{display:none !important;}
    body.scoutMode #attemptsWrap{display:none !important;}
    body.scoutMode #barsWrap{display:none !important;}

    /* --- Media Mode: Scout-like layout, but separate from Scout Mode toggle --- */
    body.mediaMode #dashPhotoBlock{display:none !important;}
    body.mediaMode #scoutPhotoBlock{display:block !important;}
    body.mediaMode #posTooltip{display:none !important;}
    body.mediaMode #posInfoBtn{display:none !important;}
    body.mediaMode #posSelect{display:none !important;}
    body.mediaMode #twoColWrap{display:none !important;}
    body.mediaMode #attemptsWrap{display:none !important;}
    body.mediaMode #barsWrap{display:none !important;}

    /* Media profile tweaks: hide phone/email, show Age */
    #scoutAgeItem{display:none;}
    body.mediaMode #scoutAgeItem{display:block;}
    body.mediaMode #scoutPhoneItem{display:none !important;}
    body.mediaMode #scoutEmailItem{display:none !important;}


    /* --- Coach Mode: hide only Athlete Profile row, keep graphs --- */
    body.coachMode #dashPhotoBlock{display:none !important;}
    body.coachMode #scoutPhotoBlock{display:block !important;}
    body.coachMode #posTooltip{display:none !important;}
    body.coachMode #posInfoBtn{display:none !important;}
    body.coachMode #posSelect{display:none !important;}


    #search{padding-right:52px;}

    /* subtle clear search */
    #clearSearch:hover{ color:#e8f0ff; }
    #clearSearch:focus{ outline:none; }

    .avatarMissing{
      position:relative;
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 34px;
    }
    .avatarMissing:before{ content:"—"; }

    .avatarBox{ position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .avatarInitials{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      letter-spacing:.5px;
      user-select:none;
    }


/* Link-style controls (from v1.0.118 look) */
.linkBtn{
  background:transparent !important;
  border:none !important;
  padding:0 !important;
  border-radius:0 !important;
  box-shadow:none !important;
  font-weight:600;
  color:var(--muted);
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.linkBtn:hover{ color:var(--text); }
.btnIcon svg{width:13px;height:13px;flex:0 0 13px;}
.controlsSpacer{flex:1 1 auto;min-width:0px;}


.btn svg{width:13px;height:13px;vertical-align:-2px;margin-right:6px;}

.kv .k, .contactLabel{font-weight:800;}

.controlsRight{display:flex;gap:10px;align-items:center;}
  .controlsRight #menuBtn{margin-right:auto;}



/* Header height lock removed in v1.0.118 (prevents small-screen misalignment) */

/* --- Responsive Drawer Nav + Mobile Modal Upgrades (v1.0.118 FULL) --- */
html, body{overflow-x:hidden;}
#menuBtn{display:none;} /* desktop hidden */

#drawerOverlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  z-index:10020; /* above header */
}
#navDrawer{
  position:fixed;
  inset:0;
  width:min(420px, 92vw);
  height:100vh;
  right:0;
  left:auto;
  transform: translateX(110%);
  transition: transform .18s ease;
  background: rgba(11,15,23,.92);
  border-left:1px solid rgba(30,42,60,.9);
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
  z-index:10030; /* above overlay */
  display:flex;
  flex-direction:column;
}
.drawerHd{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:14px;
  border-bottom:1px solid rgba(30,42,60,.9);
  background: rgba(18,26,39,.65);
  backdrop-filter: blur(10px);
}
.drawerTitle{font-weight:900;letter-spacing:.2px}
.drawerBody{
  padding:14px;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.drawerBody{
  display:flex;
  flex-direction:column;
  gap:10px;
  padding:14px;
}
/* Keep original button/link styles; only align items nicely in the drawer */
.drawerBody .btn,
.drawerBody .linkBtn{justify-content:flex-start;}

/* Primary actions inside drawer should be centered like Scout/Coach */
.drawerBody .drawerPrimary{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}

/* Scout Profile responsiveness */
@media (max-width: 820px){
  #scoutPhotoBlock .twoCol{grid-template-columns:1fr !important;}
  #athletePhotoScout{width:100% !important; max-width:340px; aspect-ratio:1/1; height:auto !important; margin:0 auto;}
}

#athletePhotoScout{width:min(340px, 100%); height:340px;}


body.drawerOpen #drawerOverlay{display:block;}
body.drawerOpen #navDrawer{transform: translateX(0);}

body.scrollLocked{overscroll-behavior: none;}

@media (max-width: 980px){
  /* show Menu button + keep Refresh visible; everything else moves into drawer via JS */
  #menuBtn{display:inline-flex;}
  header{height:auto;min-height:auto;}
  header .wrap.title{height:auto;padding-top:14px;}
  .controls{width:100%;}
  /* Keep Refresh/About grouped; search stays outside drawer */
  .controlsRight{gap:12px; width:100%; justify-content:flex-end;}
  .controlsRight #searchWrap{flex:1 1 auto; min-width:0;}
  .controlsRight #search{width:100%;}
  /* slightly tighter header spacing on mobile */
  .btn{padding:9px 11px;}
  .input{width:240px;}
}

/* Modal upgrades */
#modalOverlay{z-index:10100 !important;}
#modalBox{
  width:min(860px, 96vw) !important;
  max-height: min(86vh, 720px) !important;
  overflow:hidden !important;
  display:flex !important;
  flex-direction:column !important;
}
#modalContent{
  overflow:auto !important;
  -webkit-overflow-scrolling: touch !important;
}
@media (max-width: 520px){

  /* Must-confirm: in Media View (?view=media) on smartphone widths, hide GitHub + Changelog */
  html.mediaView #githubBtn,
  html.mediaView #versionBtn{display:none !important;}
  #modalOverlay{padding:12px !important;}
  #modalBox{width:96vw !important; max-height: 90vh !important; border-radius:16px !important;}
  #modalBox > div:first-child{flex-direction:column !important; align-items:stretch !important;}
  #modalClose{width:100%;}
}

/* Mobile athlete list: show only photo + name (compact) */
@media (max-width: 720px){
  table{font-size:14px}
  thead{display:none}
  tbody tr{
    display:flex;
    align-items:center;
    padding:10px 12px;
    border-bottom:1px solid rgba(30,42,60,.7);
  }
  tbody td{padding:0;border-bottom:0;}
  /* Keep first cell only */
  tbody td:nth-child(n+2){display:none !important;}
  tbody td:first-child{flex:1 1 auto; min-width:0;}
  tbody td:first-child strong{display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
}

/* Extra-small phones (iPhone SE width-ish): fix Athlete Profile photo sizing */
@media (max-width: 420px){
  html, body{overflow-x:hidden;}
  /* Tighten padding so the photo card never overflows on 375px widths */
  #dashPhotoBlock .bd{padding-left:12px !important; padding-right:12px !important;}
  /* Wrapper around the photo + badges */
  #dashPhotoBlock .bd > div{
    width:100% !important;
    max-width:340px !important;
  }
  /* Photo box itself */
  #athletePhotoLarge{
    width:100% !important;
    max-width:none !important;
    height:auto !important;
    aspect-ratio:1/1;
    box-sizing:border-box;
  }
}

/* Scout contact card (was missing explicit layout styles) */
.contactCard{
  border:1px solid rgba(30,42,60,.9);
  border-radius:16px;
  padding:12px;
  background: rgba(255,255,255,.02);
}
.contactGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.contactItem .label{color:var(--muted);font-size:12px;font-weight:800;}
.contactItem .value{font-weight:800;word-break:break-word;}
@media (max-width: 520px){
  .contactGrid{grid-template-columns:1fr;}
}



/* Ensure Position dropdown options remain readable across browsers */
#posSelect, #posSelect option { color: #111 !important; }
#posSelect option { background: #fff; }

/* Public View: hide advanced controls */
.publicView #photosLabel,
.publicView #csvLabel,
.publicView #githubBtn,
.publicView #versionBtn{display:none !important;}

  /* Media view: lock Media Mode button without changing visual style */
  #toggleMedia:disabled{opacity:1; cursor:default;}

/* Public view: hide Present button */
html.publicView #presentBtn{display:none !important;}

/* Media view: hide GitHub + Changelog buttons (all widths) */
html.mediaView #githubBtn,
html.mediaView #versionBtn{display:none !important;}
</style>
</head>
<body>
<header>
<div class="wrap title"><div class="titleBar"><div>
<h1>Athlete Combine Dashboard (Local) <span class="small muted" style="font-weight:700;margin-left:8px">v1.0.118</span><span class="pill pillPublic" id="publicPill" style="display:none;margin-left:8px">Public</span><span class="pill pillMedia" id="mediaPill" style="display:none;margin-left:6px">Media</span><span class="pill pillAdmin" id="adminPill" style="display:none;margin-left:6px">Admin</span></h1>
<div class="sub">Load your CSV → browse athletes → click an athlete to view best attempts, percentiles, and charts.</div>
</div><div class="topRightControls"><button class="linkBtn btnIcon" id="loadDefault" type="button"><svg aria-hidden="true" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M4 4v6h6M20 20v-6h-6M20 8a8 8 0 00-14.9-2M4 16a8 8 0 0014.9 2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span>Refresh</span></button><button class="linkBtn btnIcon" id="presentBtn" type="button" title="Open Presentation Mode">
<svg aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17.5h4.5M12 17.5V20M4 4h16v11H4V4z"></path>
</svg><span>Present</span></button><button class="btn linkBtn btnIcon" id="githubBtn" onclick="window.open('https://github.com/Eddy0412/athlete-dashboard','_blank')" title="Open project" type="button">
<svg aria-hidden="true" fill="currentColor" viewbox="0 0 24 24">
<path d="M12 .5C5.73.5.75 5.6.75 12.1c0 5.2 3.44 9.62 8.2 11.18.6.12.82-.27.82-.58v-2.1c-3.34.75-4.04-1.67-4.04-1.67-.55-1.45-1.34-1.84-1.34-1.84-1.1-.78.08-.76.08-.76 1.22.09 1.86 1.3 1.86 1.3 1.08 1.91 2.84 1.36 3.53 1.04.11-.81.42-1.36.76-1.67-2.66-.31-5.46-1.37-5.46-6.1 0-1.35.46-2.45 1.22-3.31-.12-.31-.53-1.57.12-3.27 0 0 1.01-.33 3.3 1.26.96-.27 1.98-.4 3-.4 1.02 0 2.05.14 3 .4 2.28-1.59 3.29-1.26 3.29-1.26.65 1.7.24 2.96.12 3.27.76.86 1.22 1.96 1.22 3.31 0 4.75-2.81 5.78-5.48 6.09.43.39.81 1.1.81 2.22v3.29c0 .32.22.7.83.58 4.76-1.56 8.19-5.98 8.19-11.18C23.25 5.6 18.27.5 12 .5z"></path>
</svg>
<span>GitHub</span>
</button><button class="btn linkBtn btnIcon" id="aboutBtn" style="padding:9px 10px;border-radius:999px" title="About" type="button"><svg aria-hidden="true" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span>About</span></button><button class="btn linkBtn btnIcon" id="versionBtn" style="padding:9px 10px;border-radius:999px" title="Version &amp; Changelog" type="button"><svg aria-hidden="true" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 12h6M9 16h6M14 2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V8l-5-6z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span>Changelog</span></button></div></div>

<div class="controls">
<div class="searchWrap" id="searchWrap" style="position:relative">
<input class="input" id="search" placeholder="Search athlete name…"/>
<button aria-label="Clear search" class="linkBtn btnIcon" id="clearSearch" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:var(--muted);font-size:14px;font-weight:400;cursor:pointer;padding:0;line-height:1" type="button">x</button>
</div>
<button class="btn drawerPrimary" id="toggleScout">Scout Mode: Off</button>
<button class="btn drawerPrimary" id="toggleCoach">Coach Mode: Off</button><button class="btn drawerPrimary" id="toggleMedia">Media Mode: Off</button>
<label class="btn drawerPrimary" for="photos" id="photosLabel">Load Photos</label>
<input accept="image/*" id="photos" multiple="" style="display:none" type="file" webkitdirectory=""/>
<label class="btn drawerPrimary" for="file" id="csvLabel">Load CSV</label>
<input accept=".csv,text/csv" id="file" style="display:none" type="file"/>
<div class="controlsSpacer"></div>
<div class="controlsRight">
<button aria-label="Open menu" class="linkBtn btnIcon" id="menuBtn" title="Menu" type="button"><svg aria-hidden="true" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><span>Menu</span></button>




</div>
</div>
</div>
</header>
<!-- Mobile Drawer (responsive navbar) -->
<div aria-hidden="true" id="drawerOverlay"></div>
<aside aria-label="Menu drawer" id="navDrawer">
<div class="drawerHd">
<div class="drawerTitle">Menu</div>
<button class="btn" id="drawerCloseBtn" style="padding:8px 10px;border-radius:12px" type="button">Close</button>
</div>
<div class="drawerBody" id="drawerBody"></div>
</aside>
<div class="wrap">
<div class="row">
<!-- LEFT: Athlete list -->
<div class="card">
<div class="hd">
<div>
<div style="font-weight:800">Athletes</div>
<div class="small" id="athleteCount">0 loaded</div>
</div>
<span class="pill" id="statusPill">No data</span>
</div>
<div class="bd">
<div class="drop" id="dropZone">
<div class="hint">
<strong>Tip:</strong> Load your <span class="mono">results.csv</span> (or any CSV) and optionally load an <strong>images folder</strong> named by <span class="mono">Formulario#</span> (e.g., <span class="mono">5.jpg</span>, <span class="mono">19.png</span>).
          </div>
</div>
<div style="height:12px"></div>
<div style="max-height:560px;overflow:auto;border:1px solid rgba(30,42,60,.9);border-radius:14px">
<table>
<thead>
<tr>
<th style="width:54%">Name</th>
<th style="width:10%">Age</th>
<th style="width:18%">Weight</th>
<th style="width:18%">School</th>
</tr>
</thead>
<tbody id="athleteTable"></tbody>
</table>
</div>
</div>
</div>
<!-- RIGHT: Athlete details -->
<div class="card" id="detailCard">
<div class="hd">
<div>
<div id="athleteName" style="font-weight:800">Select an athlete</div>
<div class="small" id="athleteMeta">—</div>
</div>
<span class="pill" id="dataSourcePill">—</span>
</div>
<div class="bd">
<div class="card" id="dashPhotoBlock" style="box-shadow:none;margin-bottom:12px">
<div class="hd" style="background:rgba(255,255,255,.02);display:flex;justify-content:space-between;align-items:center;gap:10px">
<div style="font-weight:800">Athlete Profile</div>
<div class="small muted">ID + position tag (auto-suggested)</div>
</div>
<div class="bd" style="display:grid;gap:10px;justify-items:center">
<div style="width:320px;max-width:100%;position:relative">
<!-- overlays -->
<div id="athleteIdBadge" style="position:absolute;top:10px;left:10px;z-index:2;
                          padding:8px 12px;border-radius:14px;
                          font-size:18px;font-weight:900;letter-spacing:.3px;
                          border:1px solid rgba(255,255,255,.18);
                          background:rgba(11,15,23,.55);
                          backdrop-filter: blur(8px);">
                #—
              </div>
<div id="athletePosBadge" style="position:absolute;top:10px;right:10px;z-index:2;
                          padding:8px 12px;border-radius:999px;
                          font-size:14px;font-weight:900;letter-spacing:.4px;
                          border:1px solid rgba(9,167,212,.35);
                          background:rgba(9,167,212,.18);
                          backdrop-filter: blur(8px);">
                —
              </div>
<!-- photo -->
<div id="athletePhotoLarge" style="width:320px;height:320px;border-radius:24px;
                          overflow:hidden;border:1px solid rgba(255,255,255,.15);
                          background:rgba(255,255,255,.04)">
<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No photo</div>
</div>
</div>
<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center">
<span class="small muted">Position:</span>
<select class="input" id="posSelect" style="width:220px">
<option value="">Auto</option>
<option>QB</option><option>RB</option><option>WR</option><option>TE</option>
<option>OL</option><option>DL</option><option>LB</option><option>DB</option>
<option>K/P</option>
</select>
<button class="btn" id="posInfoBtn" style="padding:7px 10px;border-radius:999px">?</button>
<div id="posTooltip" style="display:none;max-width:520px;text-align:left;
                   padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
                   background:rgba(11,15,23,.75);backdrop-filter: blur(10px)">
<div class="small muted" id="posExplain">—</div>
</div>
</div>
</div>
</div>
<div class="card" id="scoutPhotoBlock" style="box-shadow:none;margin-bottom:12px">
<div class="hd" style="background:rgba(255,255,255,.02)">
<div id="scoutProfileTitle" style="font-weight:800">Scout Profile</div>
<div class="small muted">Contact-ready info</div>
</div>
<div class="bd">
<div class="twoCol" style="grid-template-columns: 1fr 1fr">
<div style="position:relative;display:flex;justify-content:center">
<div id="athletePhotoScout" style="width:340px;height:340px;border-radius:24px;
                            overflow:hidden;border:1px solid rgba(255,255,255,.15);
                            background:rgba(255,255,255,.04)">
<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No photo</div>
</div>
<div id="athleteIdBadgeScout" style="position:absolute;top:12px;left:12px;z-index:2;
                            padding:8px 12px;border-radius:14px;
                            font-size:18px;font-weight:900;letter-spacing:.3px;
                            border:1px solid rgba(255,255,255,.18);
                            background:rgba(11,15,23,.55);
                            backdrop-filter: blur(8px);">
                  #—
                </div>
<div id="athletePosBadgeScout" style="position:absolute;top:12px;right:12px;z-index:2;
                            padding:8px 12px;border-radius:999px;
                            font-size:14px;font-weight:900;letter-spacing:.4px;
                            border:1px solid rgba(9,167,212,.35);
                            background:rgba(9,167,212,.18);
                            backdrop-filter: blur(8px);">
                  —
                </div>
</div>
<div class="contactCard">
<div style="font-weight:800;margin-bottom:10px">Contact details</div>
<div class="contactGrid">
<div class="contactItem">
<div class="label">DOB</div>
<div class="value" id="scoutDob">—</div>
</div>
<div class="contactItem" id="scoutAgeItem">
<div class="label">Age</div>
<div class="value" id="scoutAge">—</div>
</div>
<div class="contactItem">
<div class="label">Height</div>
<div class="value" id="scoutHeight">—</div>
</div>
<div class="contactItem">
<div class="label">Weight</div>
<div class="value" id="scoutWeight">—</div>
</div>
<div class="contactItem" id="scoutPhoneItem">
<div class="label">Phone</div>
<div class="value" id="scoutPhone">—</div>
</div>
<div class="contactItem" id="scoutEmailItem" style="grid-column:1/-1">
<div class="label">Email</div>
<div class="value" id="scoutEmail">—</div>
</div>
</div>
<div class="small muted" style="margin-top:10px">
                  Tip: take note of your preferred athlete to contact them on draft day.
                </div>
</div>
</div>
</div>
</div>
<div class="kpis" id="kpis"></div>
<div style="height:12px"></div>
<div class="twoCol" id="twoColWrap">
<div class="card" style="box-shadow:none">
<div class="hd" style="background:rgba(255,255,255,.02)">
<div style="font-weight:800">Performance Radar (percentiles)</div>
<div class="small muted">Times: lower is better • Dist/Reps: higher is better</div>
</div>
<div class="bd"><canvas id="radar"></canvas></div>
</div>
<div class="card" id="attemptsWrap" style="box-shadow:none">
<div class="hd" style="background:rgba(255,255,255,.02)">
<div style="font-weight:800">Attempts</div>
<div class="small muted">Best attempt used for ranking</div>
</div>
<div class="bd">
<div id="attempts"></div>
</div>
</div>
</div>
<div style="height:12px"></div>
<div class="card" id="barsWrap" style="box-shadow:none">
<div class="hd" style="background:rgba(255,255,255,.02)">
<div style="font-weight:800">Raw Metrics (best attempt)</div>
<div class="small muted">Quick visual of the athlete’s best values</div>
</div>
<div class="bd"><canvas id="bars"></canvas></div>
</div>
<div style="height:8px"></div>
<div class="hint">
<strong>Next step:</strong> After reviewing the data, shortlist your top athletes, compare them against your position benchmarks, write down follow‑up questions, and mark who you want to contact before draft day.</div>
</div>
</div>
</div>
</div>
<script>

// FULL production build (v1.0.118 baseline)
const IS_DEMO = false;


// View modes: default FULL, optional public view via ?view=public
const VIEW_MODE = (new URLSearchParams(window.location.search).get('view') || '').toLowerCase();
const IS_PUBLIC_VIEW = VIEW_MODE === 'public';
const IS_MEDIA_VIEW = VIEW_MODE === 'media';

// Guard: Media pill only for Media VIEW (?view=media), not Media Mode toggle
try{
  const mpGuard = document.getElementById("mediaPill");
  if (mpGuard && !IS_MEDIA_VIEW) mpGuard.style.display = "none";
}catch(e){}
if (IS_MEDIA_VIEW) { document.documentElement.classList.add('mediaView'); }

if (IS_MEDIA_VIEW) {
  try{
    const mpInit = document.getElementById("mediaPill");
    if (mpInit) mpInit.style.display = "inline-flex";
    const apInit = document.getElementById("adminPill");
    if (apInit) apInit.style.display = "none";
  }catch(e){}
}

if (IS_PUBLIC_VIEW) {
  document.documentElement.classList.add('publicView');
  const pp = document.getElementById('publicPill');
  if (pp) pp.style.display = 'inline-flex';
}
// Admin pill (default view)
try{
  const ap = document.getElementById("adminPill");
  if (ap) ap.style.display = (!IS_PUBLIC_VIEW && !IS_MEDIA_VIEW) ? "inline-flex" : "none";
}catch(e){}

/** ---------- Config: map your CSV columns here ---------- **/
const COL = {
  id: "Formulario#",
  name: "Nombre",
  age: "Edad",
  dob: "Fecha de Nacimiento",
  weight: "Peso",
  height: "Estatura",
  phone: "Celular",
  address: "Direccion",
  school: "Lugar de Estudios",
  email: "Email",

  // Attempt 1:
  dash40_1: "40 YDS DASH (SEGUNDOS)",
  broad_1: "BROAD JUMP (PULGADAS)",
  shuttle_1: "5-10-5 (SHUTTLE) RUN",
  cone_1: "3- CONE DRILL",
  bench_1: "BENCHPRESS",

  // Attempt 2:
  dash40_2: "40 YDS DASH (SEGUNDOS) 2da Vuelta",
  broad_2: "BROAD JUMP (PULGADAS) 2da Vuelta",
  shuttle_2: "5-10-5 (SHUTTLE) RUN 2da Vuelta",
  cone_2: "3- CONE DRILL 2da Vuelta",
  bench_2: "BENCH PRESS 2da Vuelta",
};

// Photo CDN (Bluehost) - expects filenames like 002.jpg
const PHOTO_BASE_URL = "https://media.kkmsports.xyz/athletes/";

function padId(id){
  const s = String(id).trim();
  if (!s) return s;
  if (/^0\d+/.test(s)) return s;
  const n = Number(s);
  if (Number.isFinite(n) && n >= 0) return String(Math.trunc(n)).padStart(3, "0");
  return s;
}



const METRICS = [
  { key:"dash40", label:"40yd", unit:"s", better:"lower", a1:COL.dash40_1, a2:COL.dash40_2 },
  { key:"broad",  label:"Broad Jump", unit:"in", better:"higher", a1:COL.broad_1, a2:COL.broad_2 },
  { key:"shuttle",label:"5-10-5", unit:"s", better:"lower", a1:COL.shuttle_1, a2:COL.shuttle_2 },
  { key:"cone",   label:"3-Cone", unit:"s", better:"lower", a1:COL.cone_1, a2:COL.cone_2 },
  { key:"bench",  label:"Bench", unit:"reps", better:"higher", a1:COL.bench_1, a2:COL.bench_2 },
];

/** ---------- State ---------- **/
let rows = [];
let filtered = [];
let activeIndex = -1;
let sourceLabel = "—";

let radarChart = null;
let barChart = null;

const posOverrides = new Map(); // athleteId -> manual position

/** ---------- Photos (local folder) ---------- **/
let photoMap = new Map(); // key (Formulario#) -> objectURL

function keyFromFilename(name){
  return String(name).toLowerCase().replace(/\.[^.]+$/, "").trim();
}

function photoKeyForRow(r){
  // Match by Formulario#.
  const idRaw = String(r[COL.id] ?? "").trim();
  if (!idRaw) return "";
  // Prefer 3-digit padding to match CDN filenames like 002.jpg
  return padId(idRaw).toLowerCase();
}

function photoUrlForRow(r){
  const idRaw = String(r[COL.id] ?? "").trim();
  if (!idRaw) return null;

  // 1) Local folder photos (if loaded)
  const keyPadded = padId(idRaw).toLowerCase();
  const keyRaw = idRaw.toLowerCase();
  const local = photoMap.get(keyPadded) || photoMap.get(keyRaw);
  if (local) return local;

  // 2) CDN fallback
  if (typeof PHOTO_BASE_URL === "string" && PHOTO_BASE_URL.trim().length){
    return PHOTO_BASE_URL + padId(idRaw) + ".jpg";
  }

  return null;
}


function updateLargePhoto(r){
  const url = photoUrlForRow(r);

  const placeholder = `<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No photo</div>`;

  function fillBox(box){
    if (!box) return;
    if (!url){
      box.innerHTML = placeholder;
      return;
    }
    box.innerHTML = "";
    const img = new Image();
    img.src = url;
    img.alt = "Athlete photo";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    img.onerror = () => { box.innerHTML = placeholder; };
    box.appendChild(img);
  }

  fillBox(document.getElementById("athletePhotoLarge"));
  fillBox(document.getElementById("athletePhotoScout"));
}

/** ---------- Helpers ---------- **/
const $ = (id) => document.getElementById(id);

function toNum(v){
  if (v === null || v === undefined) return null;
  if (typeof v === "number") return Number.isFinite(v) ? v : null;
  const s = String(v).trim();
  if (!s) return null;
  const n = Number(s.replace(",", "."));
  return Number.isFinite(n) ? n : null;
}

function normalizeStr(s){
  return String(s ?? "").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function percentileRank(values, value, better){
  // values: array of numbers (non-null)
  // return 0..100 percentile (higher = better)
  if (!values.length || value === null) return null;
  const sorted = values.slice().sort((a,b)=>a-b);
  // rank position via binary search insertion index
  let lo = 0, hi = sorted.length;
  while (lo < hi){
    const mid = (lo + hi) >> 1;
    if (sorted[mid] < value) lo = mid + 1; else hi = mid;
  }
  const countLess = lo;
  const pct = (countLess / sorted.length) * 100;
  // For better=lower: invert (lower time => higher percentile)
  return better === "lower" ? (100 - pct) : pct;
}

function formatMetric(m, v){
  if (v === null) return "—";
  if (m.unit === "s") return v.toFixed(2) + " " + m.unit;
  if (m.unit === "in") return Math.round(v) + " " + m.unit;
  if (m.unit === "reps") return Math.round(v) + " " + m.unit;
  return String(v);
}

function badgeForPercentile(p){
  if (p === null) return `<span class="badge warn">No rank</span>`;
  if (p >= 75) return `<span class="badge good">Top quartile</span>`;
  if (p >= 40) return `<span class="badge warn">Mid pack</span>`;
  return `<span class="badge bad">Needs work</span>`;
}

function safe(v){ return (v === null || v === undefined || v === "") ? "—" : String(v); }

/** ---------- CSV Loading ---------- **/
function setStatus(text){
  $("statusPill").textContent = text;
}

function setSource(text){
  sourceLabel = text;
  $("dataSourcePill").textContent = text;
}

function parseCsvText(csvText, label){
  setStatus("Parsing…");
  Papa.parse(csvText, {
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      rows = (res.data || []).filter(r => normalizeStr(r[COL.name] || "").length);
      // Clean up: convert numeric metric columns to numbers
      rows.forEach(r => {
        METRICS.forEach(m => {
          r[m.a1] = toNum(r[m.a1]);
          r[m.a2] = toNum(r[m.a2]);
        });
        r[COL.age] = toNum(r[COL.age]);
        r[COL.weight] = toNum(r[COL.weight]);
      });
      setSource(label);
      setStatus("Loaded");
      render();
      // Auto-select first athlete
      if (rows.length) selectAthlete(0);
    },
    error: (err) => {
      console.error(err);
      setStatus("Error");
      alert("Could not parse CSV. Check the file format.");
    }
  });
}

async function loadDefaultCsv(){
  try{
    setStatus("Loading…");
    const resultsUrl = new URL("./results.csv", window.location.href).toString();
    const res = await fetch(resultsUrl, { cache: "no-store" });
    // GitHub Pages + querystrings can be finicky with relative fetch paths.
    // If the first attempt fails, retry using the current pathname as base.
    let res2 = null;
    if (!res.ok) {
      try {
        const baseHref = window.location.origin + window.location.pathname;
        const retryUrl = new URL("results.csv", baseHref).toString();
        res2 = await fetch(retryUrl, { cache: "no-store" });
      } catch(e) {}
    }

    const finalRes = (res2 && res2.ok) ? res2 : res;
    if(!finalRes.ok) throw new Error("results.csv not found");
    const text = await finalRes.text();
    parseCsvText(text, "results.csv");
  }catch(e){
    console.warn(e);
    setStatus("No results.csv");
    alert("Couldn't load results.csv. Put it next to this HTML file, or use the Load CSV button.");
  }
}

/** ---------- Rendering ---------- **/
function render(){
  $("athleteCount").textContent = `${rows.length} loaded`;
  applyFilter();
}

function applyFilter(){
  const q = normalizeStr($("search").value);
  filtered = rows
    .map((r, idx) => ({ r, idx }))
    .filter(x => normalizeStr(x.r[COL.name]).includes(q))
    .sort((a,b)=> normalizeStr(a.r[COL.name]).localeCompare(normalizeStr(b.r[COL.name])));
  renderTable();
}


function initialsForRow(r){
  const full = String(r[COL.name] ?? "").trim();
  if (!full) return "—";
  const parts = full.split(/\s+/).filter(Boolean);
  const a = (parts[0] || "").slice(0,1).toUpperCase();
  const b = (parts.length>1 ? parts[parts.length-1] : "").slice(0,1).toUpperCase();
  return (a + b) || a || "—";
}

function renderTable(){
  const tb = $("athleteTable");
  tb.innerHTML = "";
  filtered.forEach((x, i) => {
    const r = x.r;
    const tr = document.createElement("tr");
    tr.dataset.idx = x.idx;
    if (x.idx === activeIndex) tr.classList.add("active");
    const url = photoUrlForRow(r);
    tr.innerHTML = `
      <td>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="avatarBox" style="width:34px;height:34px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
            ${url ? `<img class="avatarImg" data-initials="${initialsForRow(r)}" src="${url}" style="width:100%;height:100%;object-fit:cover" />` : `<div class="avatarInitials">${initialsForRow(r)}</div>`}
          </div>
          <strong>${safe(r[COL.name])}</strong>
        </div>
      </td>
      <td data-label="Age">${safe(r[COL.age])}</td>
      <td data-label="Weight">${safe(r[COL.weight])}</td>
      <td data-label="School">${safe(r[COL.school])}</td>
    `;
    tr.addEventListener("click", () => selectAthlete(x.idx));
    tb.appendChild(tr);
  });
  applyAvatarFallback();
}

function bestAttemptValue(r, m){
  const v1 = r[m.a1];
  const v2 = r[m.a2];
  if (v1 === null && v2 === null) return null;
  if (v1 === null) return v2;
  if (v2 === null) return v1;
  return (m.better === "lower") ? Math.min(v1, v2) : Math.max(v1, v2);
}

function norm01(value, min, max, invert=false){
  if (value === null || value === undefined) return null;
  const v = Math.max(min, Math.min(max, value));
  const n = (v - min) / (max - min);
  return invert ? (1 - n) : n;
}

// Simple offline "AI-like" heuristic based on combine patterns.
// Output: {pos, reason}
function suggestPosition(row){
  // pull best attempts
  const best = {};
  METRICS.forEach(m => best[m.key] = bestAttemptValue(row, m));
  const w = toNum(row[COL.weight]);
  const hStr = String(row[COL.height] ?? "").trim();

  // normalize (tuned for typical HS combine ranges; adjust later with real data)
  const speed = norm01(best.dash40, 4.4, 6.0, true);        // faster -> higher
  const explos = norm01(best.broad, 70, 130, false);        // higher -> higher
  const agility = (() => {
    const sh = norm01(best.shuttle, 3.9, 5.5, true);
    const co = norm01(best.cone, 6.5, 9.2, true);
    if (sh === null && co === null) return null;
    if (sh === null) return co;
    if (co === null) return sh;
    return (sh + co) / 2;
  })();
  const strength = norm01(best.bench, 0, 30, false);        // higher -> higher

  const heavy = (w !== null && w >= 210);
  const veryHeavy = (w !== null && w >= 250);

  // Scores per position group (very rough, but useful for an initial tag)
  const scores = {
    WR: (speed??0)*0.45 + (agility??0)*0.25 + (explos??0)*0.25 + (strength??0)*0.05,
    DB: (speed??0)*0.40 + (agility??0)*0.35 + (explos??0)*0.20 + (strength??0)*0.05,
    RB: (speed??0)*0.30 + (agility??0)*0.30 + (explos??0)*0.25 + (strength??0)*0.15,
    LB: (speed??0)*0.25 + (agility??0)*0.20 + (explos??0)*0.20 + (strength??0)*0.35 + (heavy?0.05:0),
    TE: (speed??0)*0.20 + (agility??0)*0.15 + (explos??0)*0.20 + (strength??0)*0.45 + (heavy?0.05:0),
    OL: (speed??0)*0.10 + (agility??0)*0.10 + (explos??0)*0.15 + (strength??0)*0.65 + (veryHeavy?0.10:0),
    DL: (speed??0)*0.15 + (agility??0)*0.10 + (explos??0)*0.20 + (strength??0)*0.55 + (veryHeavy?0.10:0),
    QB: (speed??0)*0.20 + (agility??0)*0.35 + (explos??0)*0.20 + (strength??0)*0.25,
    "K/P": (speed??0)*0.20 + (agility??0)*0.20 + (explos??0)*0.30 + (strength??0)*0.30
  };

  // Weight nudges
  if (veryHeavy){ scores.OL += 0.10; scores.DL += 0.08; scores.WR -= 0.08; scores.DB -= 0.08; }
  if (heavy && !veryHeavy){ scores.LB += 0.06; scores.TE += 0.05; }

  // pick best
  let bestPos = "WR", bestScore = -1;
  for (const [k,v] of Object.entries(scores)){
    if (v > bestScore){ bestScore = v; bestPos = k; }
  }

  // Build a short reason (no "real AI" claim; just heuristic)
  const parts = [];
  if (speed !== null) parts.push(`speed ${Math.round(speed*100)}`);
  if (agility !== null) parts.push(`agility ${Math.round(agility*100)}`);
  if (strength !== null) parts.push(`strength ${Math.round(strength*100)}`);
  if (explos !== null) parts.push(`explosiveness ${Math.round(explos*100)}`);
  if (w !== null) parts.push(`weight ${Math.round(w)}lb`);

  return { pos: bestPos, reason: parts.slice(0,3).join(" • ") };
}

function setPosBadge(pos, mode="auto"){
  const b = document.getElementById("athletePosBadge");
  if (!b) return;
  b.textContent = `${pos || "—"}`;
  // slight style change for manual
  if (mode === "manual"){
    b.style.borderColor = "rgba(84,113,183,.45)";
    b.style.background = "rgba(84,113,183,.22)";
  } else {
    b.style.borderColor = "rgba(9,167,212,.35)";
    b.style.background = "rgba(9,167,212,.18)";
  }
}


function computePopulationBest(m){
  const vals = [];
  rows.forEach(r => {
    const v = bestAttemptValue(r, m);
    if (v !== null) vals.push(v);
  });
  return vals;
}

function selectAthlete(originalIdx){
  activeIndex = originalIdx;
  renderTable();

  const r = rows[originalIdx];
  const photoUrl = photoUrlForRow(r);
  $("athleteName").textContent = safe(r[COL.name]);
$("athleteMeta").textContent = `Age ${safe(r[COL.age])} • ${safe(r[COL.height])} • ${safe(r[COL.weight])} lb • ${safe(r[COL.school])}`;
  updateLargePhoto(r);

  // ID badge
  const idBadge = document.getElementById("athleteIdBadge");
  const athleteId = String(r[COL.id] ?? "").trim();
  if (idBadge) idBadge.textContent = athleteId ? `#${athleteId}` : "#—";
  // Scout badges (Formulario# + suggested position)
  const idBadgeS = document.getElementById("athleteIdBadgeScout");
  if (idBadgeS) idBadgeS.textContent = athleteId ? `#${athleteId}` : "#—";

  // Suggested/selected position (reuse same logic as dashboard)
  let posValue = "—";
  try{
    const autoS = (typeof suggestPosition === "function") ? suggestPosition(r) : {pos:"—", reason:""};
    const manualS = (athleteId && typeof posOverrides !== "undefined" && posOverrides.has(athleteId)) ? posOverrides.get(athleteId) : "";
    posValue = (manualS || autoS.pos || "—");
  }catch(e){}
  const posBadgeS = document.getElementById("athletePosBadgeScout");
  if (posBadgeS) posBadgeS.textContent = posValue;

  // Scout contact details (mapped from CSV)
  const setText = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (val === null || val === undefined || String(val).trim() === "") ? "—" : String(val).trim();
  };

  const formatLbs = (val) => {
    if (val === null || val === undefined) return "—";
    const s = String(val).trim();
    if (!s) return "—";
    // Avoid double-units if CSV already includes them
    if (/\b(lb|lbs|pounds|kg|kgs)\b/i.test(s)) return s;
    // If numeric-ish, append lbs
    return s + " lbs";
  };

  setText("scoutDob", r[COL.dob]);
  setText("scoutAge", r[COL.age]);
  setText("scoutHeight", r[COL.height]);
  setText("scoutWeight", formatLbs(r[COL.weight]));
  setText("scoutPhone", r[COL.phone]);
  setText("scoutEmail", r[COL.email]);



  // Position (manual override > auto)
  const sel = document.getElementById("posSelect");
  const explain = document.getElementById("posExplain");
  const manual = athleteId && posOverrides.has(athleteId) ? posOverrides.get(athleteId) : "";
  if (sel) sel.value = manual || "";
  const auto = suggestPosition(r);
  const pos = manual || auto.pos;
  setPosBadge(pos, manual ? "manual" : "auto");
  if (explain) explain.textContent = manual ? "(manual)" : `(auto: ${auto.reason})`;

  $("dataSourcePill").textContent = sourceLabel;

  // KPI cards
  const kpis = $("kpis");
  kpis.innerHTML = "";
  METRICS.forEach(m => {
    const best = bestAttemptValue(r, m);
    const pop = computePopulationBest(m);
    const p = percentileRank(pop, best, m.better);
    const el = document.createElement("div");
    el.className = "kpi";
    el.innerHTML = `
      <div class="label">${m.label}</div>
      <div class="value">${formatMetric(m, best)}</div>
      <div class="meta">Percentile: <strong>${p===null ? "—" : Math.round(p)}</strong> ${badgeForPercentile(p)}</div>
    `;
    kpis.appendChild(el);
  });

  // Attempts table
  const attempts = $("attempts");
  attempts.innerHTML = "";
  METRICS.forEach(m => {
    const v1 = r[m.a1], v2 = r[m.a2];
    const best = bestAttemptValue(r, m);
    const a1 = (v1 === null) ? "—" : formatMetric(m, v1);
    const a2 = (v2 === null) ? "—" : formatMetric(m, v2);
    const b  = (best === null) ? "—" : formatMetric(m, best);
    const used = (best === null) ? "" : (best === v1 ? "Attempt 1" : "Attempt 2");
    const box = document.createElement("div");
    box.style.marginBottom = "10px";
    box.style.padding = "10px";
    box.style.border = "1px solid rgba(30,42,60,.9)";
    box.style.borderRadius = "14px";
    box.style.background = "rgba(255,255,255,.02)";
    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div style="font-weight:800">${m.label}</div>
        <div class="small muted">${used ? "Best = " + used : ""}</div>
      </div>
      <div class="small" style="margin-top:6px">
        <div>Attempt 1: <span class="mono">${a1}</span></div>
        <div>Attempt 2: <span class="mono">${a2}</span></div>
        <div style="margin-top:6px">Best: <strong class="mono">${b}</strong></div>
      </div>
    `;
    attempts.appendChild(box);
  });

  // Charts
  renderRadar(r);
  renderBars(r);

  // Sync selection to presenter window (if open)
  _sendToPresenter({ type: "ac_athlete_update", athlete: rowToPresenter(r) });
}

function renderRadar(r){
  const labels = METRICS.map(m => m.label);
  const data = METRICS.map(m => {
    const best = bestAttemptValue(r, m);
    const pop = computePopulationBest(m);
    const p = percentileRank(pop, best, m.better);
    return p === null ? 0 : Math.max(0, Math.min(100, p));
  });

  const ctx = $("radar").getContext("2d");
  if (radarChart) radarChart.destroy();
  radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "Percentile",
        data,
        fill: true,
        borderWidth: 2,
        pointRadius: 3,
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { backdropColor: "transparent", color: "rgba(232,240,255,.75)" },
          grid: { color: "rgba(138,160,182,.22)" },
          angleLines: { color: "rgba(138,160,182,.22)" },
          pointLabels: { color: "rgba(232,240,255,.9)", font: { size: 12, weight: "Peso" } }
        }
      },
      plugins: {
        legend: { labels: { color: "rgba(232,240,255,.85)" } },
        tooltip: {
          callbacks: {
            label: (ctx) => ` ${Math.round(ctx.parsed.r)}th percentile`
          }
        }
      }
    }
  });
}

function renderBars(r){
  const labels = METRICS.map(m => `${m.label} (${m.unit})`);
  const values = METRICS.map(m => bestAttemptValue(r, m) ?? 0);

  const ctx = $("bars").getContext("2d");
  if (barChart) barChart.destroy();
  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Best attempt value",
        data: values,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "rgba(232,240,255,.85)" } },
        tooltip: {
          callbacks: {
            label: (ctx) => ` ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: { ticks: { color: "rgba(232,240,255,.85)" }, grid: { color: "rgba(138,160,182,.16)" } },
        y: { ticks: { color: "rgba(232,240,255,.85)" }, grid: { color: "rgba(138,160,182,.16)" } }
      }
    }
  });
}

/** ---------- Events ---------- **/

// Position tooltip toggle
const posInfoBtn = document.getElementById("posInfoBtn");
const posTooltip = document.getElementById("posTooltip");
if (posInfoBtn && posTooltip){
  posInfoBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    const open = posTooltip.style.display !== "none";
    posTooltip.style.display = open ? "none" : "block";
  });
  document.addEventListener("click", ()=>{ posTooltip.style.display = "none"; });
  posTooltip.addEventListener("click", (e)=> e.stopPropagation());
}


// Manual position override (stored locally in-memory)
const posSel = document.getElementById("posSelect");
if (posSel){
  posSel.addEventListener("change", ()=>{
    if (activeIndex < 0) return;
    const r = rows[activeIndex];
    const athleteId = String(r[COL.id] ?? "").trim();
    if (!athleteId) return;

    const v = String(posSel.value ?? "").trim();
    if (!v){
      posOverrides.delete(athleteId);
    } else {
      posOverrides.set(athleteId, v);
    }

    const auto = suggestPosition(r);
    const pos = v || auto.pos;
    setPosBadge(pos, v ? "manual" : "auto");

    const explain = document.getElementById("posExplain");
    if (explain) explain.textContent = v ? "(manual)" : `(auto: ${auto.reason})`;
  });
}



$("photos").addEventListener("change", (e) => {
  photoMap.clear();
  const files = e.target.files ? Array.from(e.target.files) : [];
  for (const f of files) {
    const key = keyFromFilename(f.name);
    if (key) photoMap.set(key, URL.createObjectURL(f));
  }
  // Re-render list and refresh selected athlete
  renderTable();
  if (rows.length && activeIndex < 0) { selectAthlete(0); }
  else if (activeIndex >= 0) { selectAthlete(activeIndex); }
});

$("file").addEventListener("change", (e) => {
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => parseCsvText(reader.result, f.name);
  reader.readAsText(f);
});

$("search").addEventListener("input", applyFilter);
$("loadDefault").addEventListener("click", loadDefaultCsv);
// Presentation window sync (index controls, external fullscreen presenter)
let _presentWin = null;
let _presentReady = false;

function _sendToPresenter(payload){
  try{
    if(_presentWin && !_presentWin.closed){
      _presentWin.postMessage(payload, "*");
    }
  }catch(e){}

function rowToPresenter(r){
  // Provide presenter-friendly payload while preserving existing row object keys
  try{
    return Object.assign({}, r, { _photoUrl: (typeof photoUrlForRow === "function" ? photoUrlForRow(r) : "") });
  }catch(e){
    return Object.assign({}, r);
  }
}

}

function _sendCurrentToPresenter(){
  try{
    if(typeof activeIndex !== "number" || activeIndex < 0) return;
    const r = rows?.[activeIndex];
    if(!r) return;
    _sendToPresenter({ type: "ac_athlete_update", athlete: rowToPresenter(r) });
  }catch(e){}
}

window.addEventListener("message", (e) => {
  if(e?.data?.type === "ac_presentation_ready"){
    _presentReady = true;
    _sendCurrentToPresenter();
  }
});

$("presentBtn")?.addEventListener("click", () => {
  _presentReady = false;
  // Keep opener available (no noopener) so presenter can handshake back
  _presentWin = window.open("presentation.html", "ac_presenter", "popup=1");
  // Best-effort initial send (presenter will also request via ready handshake)
  setTimeout(_sendCurrentToPresenter, 250);
});

// Drag & drop
const dz = $("dropZone");
dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.style.borderColor = "rgba(9,167,212,.8)"; });
dz.addEventListener("dragleave", ()=>{ dz.style.borderColor = "rgba(138,160,182,.45)"; });
dz.addEventListener("drop", (e)=>{
  e.preventDefault();
  dz.style.borderColor = "rgba(138,160,182,.45)";
  const f = e.dataTransfer.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => parseCsvText(reader.result, f.name);
  reader.readAsText(f);
});

// Optional: try auto-load if results.csv exists
// (works only when served via a local server; some browsers block fetch() for file://)

// Coach mode toggle (layout-only; mutually exclusive with Scout Mode)
const coachBtn = document.getElementById("toggleCoach");
function setCoachMode(on){
  if (on) { try{ setMediaMode(false); }catch(e){} }
  document.body.classList.toggle("coachMode", !!on);
  if (coachBtn) coachBtn.textContent = `Coach Mode: ${on ? "On" : "Off"}`;
  if (on) { document.body.classList.remove("scoutMode"); if (toggleBtn) toggleBtn.textContent = "Scout Mode: Off"; }
  try{ sessionStorage.setItem("coachModeOn", on ? "1" : "0"); }catch(e){}
}
if (coachBtn){
  coachBtn.addEventListener("click", ()=>{
    const on = !document.body.classList.contains("coachMode");
    setCoachMode(on);
    if (document.body.classList.contains("drawerOpen")) closeDrawer();
  });
}
if (!IS_PUBLIC_VIEW) {
  try{ setCoachMode(sessionStorage.getItem("coachModeOn")==="1"); }catch(e){}
}

// Scout mode toggle (layout-only)
const toggleBtn = document.getElementById("toggleScout");
function setScoutMode(on){
  if (on) { try{ setMediaMode(false); }catch(e){} }
  if (on) { document.body.classList.remove("coachMode"); try{ sessionStorage.setItem("coachModeOn","0"); }catch(e){} if (coachBtn) coachBtn.textContent = "Coach Mode: Off"; }

  document.body.classList.toggle("scoutMode", !!on);
  if (toggleBtn) toggleBtn.textContent = `Scout Mode: ${on ? "On" : "Off"}`;
  try{ sessionStorage.setItem("scoutModeOn", on ? "1" : "0"); }catch(e){}
}
if (toggleBtn){
  toggleBtn.addEventListener("click", ()=>{
    const on = !document.body.classList.contains("scoutMode");
    setScoutMode(on);
    if (document.body.classList.contains("drawerOpen")) closeDrawer();
  });
}
// restore mode
if (!IS_PUBLIC_VIEW) {
  try{ setScoutMode(sessionStorage.getItem("scoutModeOn")==="1"); }catch(e){}
}



// Media mode toggle (independent; used for shared/public-facing UI)
const mediaBtn = document.getElementById("toggleMedia");
let __prevScoutForMedia = null;
let __prevCoachForMedia = null;
function setMediaMode(on){
  let isOn = !!on;
  // In ?view=media, Media Mode is locked ON
  if (IS_MEDIA_VIEW && !isOn) { isOn = true; }

  // Preserve prior modes so toggling Media doesn't permanently change user state
  if (isOn){
    if (__prevScoutForMedia === null) __prevScoutForMedia = document.body.classList.contains("scoutMode");
    if (__prevCoachForMedia === null) __prevCoachForMedia = document.body.classList.contains("coachMode");
  }

  // Media Mode should be mutually exclusive with Scout/Coach
  if (isOn){
    try{ setScoutMode(false); }catch(e){}
    try{ setCoachMode(false); }catch(e){}
  }

  document.body.classList.toggle("mediaMode", isOn);
  if (mediaBtn) mediaBtn.textContent = `Media Mode: ${isOn ? "On" : "Off"}`;

  // Update profile title + pills
  const spt = document.getElementById("scoutProfileTitle");
  if (spt) spt.textContent = isOn ? "Media Profile" : "Scout Profile";
  const mp = document.getElementById("mediaPill"); if (mp && IS_MEDIA_VIEW) mp.style.display = "inline-flex";

  // Media Mode uses a Scout-like layout via CSS (body.mediaMode) but MUST NOT toggle Scout Mode itself.
  if (!isOn){
    // restore prior modes if we had them
    if (__prevScoutForMedia !== null) { try{ setScoutMode(!!__prevScoutForMedia); }catch(e){} }
    if (__prevCoachForMedia !== null) { try{ setCoachMode(!!__prevCoachForMedia); }catch(e){} }
    __prevScoutForMedia = null;
    __prevCoachForMedia = null;
  }

  try{ sessionStorage.setItem("mediaModeOn", isOn ? "1" : "0"); }catch(e){}
}
if (mediaBtn){
  mediaBtn.addEventListener("click", ()=>{
    if (IS_MEDIA_VIEW) { setMediaMode(true); return; }
    const on = !document.body.classList.contains("mediaMode");
    setMediaMode(on);
    if (document.body.classList.contains("drawerOpen")) closeDrawer();
  });
}
// restore / initialize
try{
  if (IS_MEDIA_VIEW) {
    setMediaMode(true);
    if (mediaBtn) { mediaBtn.disabled = true; mediaBtn.classList.add('locked'); }
  } else {
    setMediaMode(sessionStorage.getItem("mediaModeOn")==="1");
  }
}catch(e){}

// Media view layout is driven by Media Mode (body.mediaMode) and does not force Scout Mode.
let __scrollLockCount = 0;
let __scrollLockY = 0;
function lockScroll(){
  __scrollLockCount += 1;
  if (__scrollLockCount !== 1) return;
  __scrollLockY = window.scrollY || window.pageYOffset || 0;
  document.body.classList.add("scrollLocked");
  document.body.style.position = "fixed";
  document.body.style.top = `-${__scrollLockY}px`;
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.width = "100%";
}
function unlockScroll(){
  __scrollLockCount = Math.max(0, __scrollLockCount - 1);
  if (__scrollLockCount !== 0) return;
  document.body.classList.remove("scrollLocked");
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.width = "";
  window.scrollTo(0, __scrollLockY || 0);
}

function openModal(title, htmlContent){
  const ov = document.getElementById("modalOverlay");
  const t = document.getElementById("modalTitle");
  const c = document.getElementById("modalContent");
  if (!ov || !t || !c) return;

  // Ensure drawer isn't trapping focus/scroll when modal opens
  closeDrawer();

  t.textContent = title;
  c.innerHTML = htmlContent;
  ov.style.display = "flex";
  lockScroll();
}
function closeModal(){
  const ov = document.getElementById("modalOverlay");
  if (ov && ov.style.display !== "none"){
    ov.style.display = "none";
    unlockScroll();
  }
}





/* --- Responsive hamburger + drawer nav (FULL) --- */
function initResponsiveNav(){
  const mq = window.matchMedia("(max-width: 980px)");
  const drawer = document.getElementById("navDrawer");
  const overlay = document.getElementById("drawerOverlay");
  const menuBtn = document.getElementById("menuBtn");
  const closeBtn = document.getElementById("drawerCloseBtn");
  const drawerBody = document.getElementById("drawerBody");
  const controlsRight = document.querySelector(".controlsRight");
  const searchWrap = document.getElementById("searchWrap");

  if (!drawer || !overlay || !menuBtn || !closeBtn || !drawerBody) return;

  const moveEls = [
    document.getElementById("toggleScout"),
    document.getElementById("toggleCoach"),
    document.getElementById("toggleMedia"),
    document.getElementById("photosLabel"),
    document.getElementById("csvLabel"),
  ].filter(Boolean);

  const searchOriginalSpot = searchWrap ? { parent: searchWrap.parentNode, next: searchWrap.nextSibling } : null;

  const originalSpots = moveEls.map(el=>({
    el,
    parent: el.parentNode,
    next: el.nextSibling
  }));

  function moveToDrawer(){
    moveEls.forEach(el=> drawerBody.appendChild(el));
  }
  function restoreFromDrawer(){
    originalSpots.forEach(({el,parent,next})=>{
      if (!parent) return;
      if (next && next.parentNode === parent) parent.insertBefore(el, next);
      else parent.appendChild(el);
    });
  }

  function setMobileLayout(isMobile){
    if (isMobile){
      moveToDrawer();
      // Keep athlete search outside the drawer; place it next to Menu/Refresh on mobile
      if (searchWrap && controlsRight && !controlsRight.contains(searchWrap)){
        controlsRight.insertBefore(searchWrap, controlsRight.firstChild);
      }
      overlay.setAttribute("aria-hidden", document.body.classList.contains("drawerOpen") ? "false" : "true");
    } else {
      closeDrawer(true);
      restoreFromDrawer();
      // Restore search to its original position
      if (searchWrap && searchOriginalSpot && searchOriginalSpot.parent){
        const { parent, next } = searchOriginalSpot;
        if (next && next.parentNode === parent) parent.insertBefore(searchWrap, next);
        else parent.appendChild(searchWrap);
      }
    }
  }

  menuBtn.addEventListener("click", ()=>{
    closeModal();
    openDrawer();
  });
  closeBtn.addEventListener("click", ()=> closeDrawer());
  overlay.addEventListener("click", ()=> closeDrawer());
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeDrawer(); });

  if (mq.addEventListener) mq.addEventListener("change", (e)=> setMobileLayout(e.matches));
  else mq.addListener((e)=> setMobileLayout(e.matches));

  setMobileLayout(mq.matches);
}

function openDrawer(){
  const mq = window.matchMedia("(max-width: 980px)");
  if (!mq.matches) return;
  const overlay = document.getElementById("drawerOverlay");
  document.body.classList.add("drawerOpen");
  if (overlay) overlay.setAttribute("aria-hidden","false");
  lockScroll();
}
function closeDrawer(skipUnlock){
  const overlay = document.getElementById("drawerOverlay");
  if (!document.body.classList.contains("drawerOpen")) return;
  document.body.classList.remove("drawerOpen");
  if (overlay) overlay.setAttribute("aria-hidden","true");
  if (!skipUnlock) unlockScroll();
}

function initModalWiring(){
  const modalClose = document.getElementById("modalClose");
  const modalOverlay = document.getElementById("modalOverlay");
  const aboutBtn = document.getElementById("aboutBtn");
  const versionBtn = document.getElementById("versionBtn");

  if (modalClose) modalClose.addEventListener("click", closeModal);
  if (modalOverlay) modalOverlay.addEventListener("click", (e)=>{ if (e.target === modalOverlay) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

  if (aboutBtn){
    aboutBtn.addEventListener("click", ()=>{
      openModal("How to use this dashboard", `
        <div style="display:grid;gap:10px">
          <div><b>1) Load CSV:</b> Click <span class="mono">Choose CSV</span> and select your combine results CSV.</div>
          <div><b>2) Load photos:</b> Click <span class="mono">Load Photos</span> and select the folder containing athlete photos named by <span class="mono">Formulario#</span> (example: <span class="mono">75.jpg</span>).</div>
          <div><b>3) Browse athletes:</b> Use the left list to filter and select a player.</div>
          <div><b>4) Modes:</b>
            <ul style="margin:6px 0 0 18px">
              <li><b>Normal:</b> Full dashboard view + position suggestion controls.</li>
              <li><b>Scout Mode:</b> Scout Profile layout (contact-first).</li>
              <li><b>Coach Mode:</b> Scout Profile layout + keeps performance charts/sections below.</li>
            </ul>
          </div>
        </div>
      `);
    });
  }

  if (versionBtn){
    versionBtn.addEventListener("click", ()=>{
      openModal("Version & Changelog", `<div style="display:grid;gap:10px">
  <div style="font-weight:900">What’s new</div>
  <div><b>v1.0.118</b> — Public View + header layout polish (UI fixes only).</div>

  <div style="margin-top:10px;font-weight:900">Changelog</div>

<div style="margin-top:6px;font-weight:900">v1.0.118</div>
<ul style="margin:6px 0 0 18px">
  <li>Added <span class="mono">?view=public</span> mode for sharing a simplified UI externally.</li>
  <li>Public View hides: Load Photos, Load CSV, GitHub, and Changelog buttons.</li>
  <li>Public View keeps <b>Scout Mode</b> and <b>Coach Mode</b> toggles available.</li>
  <li>Header controls aligned under the title; improved spacing so Search/Refresh/About are not pushed up on mobile.</li>
  <li>Added a subtle <b>Public</b> pill indicator when Public View is active.</li>
</ul>

<div style="margin-top:6px;font-weight:900">v1.0.118</div>
<ul style="margin:6px 0 0 18px">
  <li>Added responsive hamburger drawer nav (overlay header, tap-to-close, click-safe buttons).</li>
  <li>Mobile modals improved: max-size, internal scroll, iOS-safe scrolling, background scroll lock.</li>
  <li>Kept Athlete Search visible outside drawer next to Menu + Refresh on mobile.</li>
  <li>Optimized Athlete List on mobile to show only photo + name (compact rows).</li>
  <li>Improved small-phone (≈375px) Athlete Profile responsiveness; fixed photo box clipping.</li>
  <li>Improved Position dropdown option readability.</li>
  <li>Scout/Coach contact details: added <span class="mono">lbs</span> unit for weight.</li>
  <li>Updated guidance text to draft-day coaching suggestions.</li>
</ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>Added complete version history (v1.0.118 → v1.0.118) inside the Changelog modal.</li>
    <li>Kept About/Changelog modal behavior identical to the stable build.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>Locked header height to 128px (prevents layout jumps).</li>
    <li>Improved toolbar spacing (no overlap with content).</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>Refresh control switched to link-style to match About/Changelog group.</li>
    <li>Initial header height lock introduced (later refined in v1.0.118).</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>controlsSpacer min-width set to 0px.</li>
    <li>“Load Photos Folder” renamed to “Load Photos”.</li>
    <li>GitHub link updated to repository URL.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>Header right-side control order finalized: Refresh | GitHub | About | Changelog.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>Navigation layout fixes (single-row header).</li>
    <li>GitHub button added to header controls.</li>
    <li>controlsSpacer tuned for better alignment.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.118</div>
  <ul style="margin:6px 0 0 18px">
    <li>Merged stable modal system from v8.1j-alpha with updated header link-style controls.</li>
    <li>Standardized small SVG icon sizing for header controls.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v8.1j-alpha</div>
  <ul style="margin:6px 0 0 18px">
    <li>Baseline build with smooth working About/Changelog modals.</li>
    <li>Left list initials fallback for missing photos.</li>
  </ul>
</div>`);
    });
  }
}
document.addEventListener("DOMContentLoaded", initModalWiring);


// Search clear (X) button
const searchEl = document.getElementById("search");
const clearBtn = document.getElementById("clearSearch");
function toggleClearSearch(){
  if (!searchEl || !clearBtn) return;
  clearBtn.style.display = searchEl.value && searchEl.value.trim().length ? "inline-flex" : "none";
}
if (searchEl){
  searchEl.addEventListener("input", toggleClearSearch);
  // also show/hide on page load
  setTimeout(toggleClearSearch, 0);
}
if (clearBtn && searchEl){
  clearBtn.addEventListener("click", ()=>{
    searchEl.value = "";
    toggleClearSearch();
    // trigger existing filter logic
    searchEl.dispatchEvent(new Event("input", { bubbles:true }));
    searchEl.focus();
  });
}


function applyAvatarFallback(){
  // Replace broken avatar <img> with a subtle placeholder (no broken image icon)
  document.querySelectorAll("img.avatarImg").forEach(img=>{
    if (img.dataset.fallbackBound) return;
    img.dataset.fallbackBound = "1";
    img.addEventListener("error", ()=>{
      const ph=document.createElement("div"); ph.className="avatarInitials"; ph.textContent=img.dataset.initials||"—"; img.replaceWith(ph);
    });
  });
}

// Public view mode (?view=public): simplified UI + default Coach Mode
function applyPublicViewMode(){
  // Force Coach Mode on, Scout Mode off (do not rely on session storage)
  try{ setScoutMode(false); }catch(e){}
  try{ setCoachMode(true); }catch(e){}

  // Hide controls not meant for public users
  // Keep mode toggles visible even in public view (requested for coaches/scouts)
  const hideIds = ["photosLabel","csvLabel","githubBtn","versionBtn"];
  hideIds.forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
}
if (IS_PUBLIC_VIEW){
  applyPublicViewMode();
}


initResponsiveNav();

setStatus("Ready");

</script>
<!-- Modals -->
<div id="modalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:9999;align-items:center;justify-content:center;padding:18px">
<div id="modalBox" style="width:min(860px, 96vw);max-height:86vh;overflow:auto;background:rgba(18,26,39,.98);border:1px solid rgba(30,42,60,.9);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.5)">
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:14px 14px;border-bottom:1px solid rgba(30,42,60,.9)">
<div id="modalTitle" style="font-weight:900">Modal</div>
<button class="btn" id="modalClose" style="padding:8px 10px;border-radius:12px">Close</button>
</div>
<div id="modalContent" style="padding:14px"></div>
</div>
</div>
</body>
</html>
