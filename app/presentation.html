<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Presentation Mode v1.0.120</title>
<style>
  :root{
    --bg:#070b16;
    --panel: rgba(255,255,255,.06);
    --border: rgba(255,255,255,.14);
    --text:#eef3ff;
    --muted:#a7b3d6;
    --accent:#51CAF5;
    --accent2:#5471B7;
    --radius:18px;
    --shadow: 0 20px 70px rgba(0,0,0,.55);
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:var(--font);
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(81,202,245,.16), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(84,113,183,.18), transparent 60%),
      var(--bg);
    overflow:hidden;
  }

  .wrap{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr;
  }

  .topbar{
    padding: 14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    background: linear-gradient(to bottom, rgba(7,11,22,.88), rgba(7,11,22,.55));
    backdrop-filter: blur(10px);
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:4px;
    min-width: 220px;
  }
  .brand .title{
    font-weight: 800;
    letter-spacing: .2px;
    font-size: 16px;
    margin:0;
  }
  .brand .sub{
    color: var(--muted);
    font-size: 12px;
  }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .btn{
    appearance:none;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    font-size: 13px;
    line-height:1;
    user-select:none;
  }
  .btn:hover{ border-color: rgba(81,202,245,.35); }
  .btn:active{ transform: translateY(1px); }
  .btnGhost{ background: transparent; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border:1px solid rgba(255,255,255,.18);
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    background: rgba(255,255,255,.06);
  }

  .stage{
    padding: 18px;
    display:grid;
    place-items:center;
  }
  .card{
    width: min(1100px, 100%);
    border: 1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardInner{
    padding: 22px;
    display:grid;
    grid-template-columns: 340px 1fr;
    gap: 18px;
  }

  .photo{
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    background: rgba(0,0,0,.18);
    overflow:hidden;
    min-height: 360px;
    display:flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.45);
    position:relative;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit: cover;
    display:block;
  }

  .name{
    font-size: 40px;
    font-weight: 900;
    letter-spacing: .2px;
    margin:0 0 10px 0;
  }
  .metaRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom: 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }
  .stat{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    border-radius: 14px;
    padding: 12px;
  }
  .stat .k{
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 6px;
  }
  .stat .v{
    font-size: 18px;
    font-weight: 800;
    letter-spacing: .2px;
  }

  .footerHint{
    padding: 12px 18px;
    border-top: 1px solid rgba(255,255,255,.10);
    color: var(--muted);
    font-size: 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }

  @media (max-width: 900px){
    .cardInner{ grid-template-columns: 1fr; }
    .photo{ min-height: 260px; }
    .name{ font-size: 32px; }
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 520px){
    .stage{ padding: 12px; }
    .cardInner{ padding: 14px; }
    .name{ font-size: 26px; }
    .grid{ grid-template-columns: 1fr; }
  }

#photoFallback{ font-size:64px; letter-spacing:1px; }

/* Template: KFL (minimal variant) */
body.tplKfl{ background: radial-gradient(1200px 600px at 20% 20%, rgba(0,180,160,.18), rgba(0,0,0,0)) , radial-gradient(900px 500px at 80% 10%, rgba(84,113,183,.22), rgba(0,0,0,0)), #070b10; }
body.tplKfl .card{ border-color: rgba(0,255,220,.18); }

/* --- KFL TEMPLATE --- */
#kflRoot{ position:fixed; inset:0; display:none; overflow:hidden; font-family:var(--font); }
#kflRoot .kflStage{ position:absolute; inset:0; background:#0b63a4; }
#kflRoot .kflStage:before{
  content:""; position:absolute; inset:0;
  background:
    radial-gradient(1200px 700px at 70% 10%, rgba(255,255,255,.08), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,0) 35%);
  pointer-events:none;
}
#kflRoot .kflInner{ position:absolute; inset:32px; display:grid; grid-template-columns: 44% 56%; gap:28px; }
#kflRoot .left{
  position:relative; border-radius:16px; overflow:hidden;
  background:
    linear-gradient(0deg, rgba(0,0,0,.35), rgba(0,0,0,0)),
    repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 10px, rgba(255,255,255,0) 10px 22px),
    rgba(0,0,0,.18);
  box-shadow: 0 26px 80px rgba(0,0,0,.45);
}
#kflRoot .left .photoBox{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
#kflRoot .left img{ width:100%; height:100%; object-fit:cover; display:block; }
#kflRoot .left .photoFallback{
  width:100%; height:100%; display:flex; align-items:center; justify-content:center;
  font-weight:1000; font-size:72px; letter-spacing:2px; color:rgba(255,255,255,.9);
  background:rgba(0,0,0,.12);
}
#kflRoot .nameBar{
  position:absolute; left:0; right:0; bottom:0;
  background:rgba(255,255,255,.92); color:#0b1b2b;
  padding:18px 22px; font-weight:1000; font-size:44px; line-height:1;
  text-transform:none;
}
#kflRoot .right{ position:relative; padding:6px 8px; color:#fff; }
#kflRoot .draft{
  position:absolute; top:0; right:0;
  background:#e13b3b; color:#fff; font-weight:1000;
  padding:16px 22px; font-size:56px; letter-spacing:1px;
  border-radius:0;
}
#kflRoot .kflLogo{
  margin-top:130px; display:flex; flex-direction:column; align-items:center; gap:10px;
}
#kflRoot .kflLogo .badge{
  width:150px; height:150px; border-radius:22px;
  display:flex; align-items:center; justify-content:center;
  border:3px solid rgba(255,255,255,.35);
  background:rgba(0,0,0,.10);
  font-weight:1000; font-size:56px;
}
#kflRoot .kflLogo .sub{
  font-weight:900; font-size:20px; opacity:.9; letter-spacing:.6px;
}
#kflRoot .info{
  margin-top:18px; text-align:center; font-weight:900;
}
#kflRoot .info .line{ font-size:22px; margin:8px 0; letter-spacing:.4px; }
#kflRoot .info .small{ font-size:18px; opacity:.95; }
#kflRoot .sectionTitle{
  margin-top:44px; text-align:center; font-weight:1000;
  font-size:34px; letter-spacing:1px;
}
#kflRoot .perf{
  margin-top:18px;
  display:grid; grid-template-columns: repeat(5, 1fr);
  gap:18px;
  align-items:stretch;
}
#kflRoot .perf .cell{
  border-left:1px solid rgba(255,255,255,.35);
  padding-left:16px;
}
#kflRoot .perf .cell:first-child{ border-left:none; padding-left:0; }
#kflRoot .perf .label{
  font-weight:900; font-size:16px; opacity:.95; letter-spacing:.4px;
  text-transform:uppercase; line-height:1.2;
}
#kflRoot .perf .value{
  margin-top:14px;
  font-weight:1000; font-size:54px; color:#e13b3b;
  letter-spacing:.5px;
}
#kflRoot .footerSite{
  position:absolute; left:0; right:0; bottom:24px;
  text-align:center; font-weight:1000; letter-spacing:1px;
  font-size:22px;
}
#kflRoot .accentSlash{
  position:absolute; width:130px; height:260px;
  background:#e13b3b;
  transform:skewX(-20deg);
  opacity:1;
}
#kflRoot .accentSlash.s1{ left:22px; top:54px; }
#kflRoot .accentSlash.s2{ left:22px; bottom:40px; }
#kflRoot .accentSlash.s3{ right:22px; bottom:64px; }
@media (max-width: 1024px){
  #kflRoot .kflInner{ inset:18px; grid-template-columns: 1fr; }
  #kflRoot .draft{ font-size:44px; }
  #kflRoot .nameBar{ font-size:36px; }
  #kflRoot .perf{ grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>
<div id="tplTag" style="position:fixed;top:18px;left:18px;z-index:50;display:none;padding:6px 10px;border-radius:999px;font-weight:900;letter-spacing:.4px;border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.35);backdrop-filter:blur(6px)">KFL</div>

  <div id="defaultRoot"><div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1 class="title">Presentation Mode</h1>
        <div class="sub">Arrow keys: Prev/Next • F: Fullscreen • Esc: Exit fullscreen</div>
      </div>
      <div class="actions">
        <span class="pill" id="counterPill">— / —</span>
        <button class="btn" id="prevBtn" type="button">Prev</button>
        <button class="btn" id="nextBtn" type="button">Next</button>
        <button class="btn btnGhost" id="fsBtn" type="button">Fullscreen</button>
        <button class="btn btnGhost" id="exitBtn" type="button">Exit</button>
      </div>
    </div>

    <div class="stage">
      <div class="card" role="region" aria-label="Presentation card">
        <div class="cardInner">
          <div class="photo">
            <img id="photoImg" alt="" style="display:none"/>
            <div id="photoFallback">No photo</div>
          </div>

          <div>
            <h2 class="name" id="name">—</h2>
            <div class="metaRow" id="metaRow"></div>

            <div class="grid" id="stats"></div>
          </div>
        </div>

        <div class="footerHint">
          <div id="school">—</div>
          <div id="location">—</div>
        </div>
      </div>
    </div>
  </div></div>

<!-- KFL Template Root -->
<div id="kflRoot" style="display:none">
  <div class="kflStage">
    <div class="accentSlash s1"></div>
    <div class="accentSlash s2"></div>
    <div class="accentSlash s3"></div>

    <div class="kflInner">
      <div class="left">
        <div class="photoBox">
          <img id="kflPhotoImg" alt="" style="display:none"/>
          <div id="kflPhotoFallback" class="photoFallback">—</div>
        </div>
        <div class="nameBar" id="kflName">—</div>
      </div>

      <div class="right">
        <div class="draft">DRAFT 2025</div>

        <div class="kflLogo">
          <div class="badge">KFL</div>
          <div class="sub">KIWANIS FOOTBALL LEAGUE • PANAMA</div>
        </div>

        <div class="info">
          <div class="line" id="kflSchoolLine">COLEGIO: —</div>
          <div class="line small" id="kflHeightLine">ESTATURA: —</div>
          <div class="line small" id="kflWeightLine">PESO: —</div>
        </div>

        <div class="sectionTitle">COMBINE PERFORMANCE</div>

        <div class="perf" id="kflPerf"></div>

        <div class="footerSite">WWW.KIWANISFOOTBALL.COM</div>
      </div>
    </div>
  </div>
</div>

<script>
function getHashParam(name){
  try{
    const h = (location.hash || "").replace(/^#/, "");
    const p = new URLSearchParams(h);
    return p.get(name) || "";
  }catch(e){ return ""; }
}

(function(){
  const PHOTO_BASE_URL = "https://media.kkmsports.xyz/athletes/";

  const $ = (id)=>document.getElementById(id);

  const el = {
    name: $("name"),
    meta: $("metaRow"),
    stats: $("stats"),
    school: $("school"),
    location: $("location"),
    photoImg: $("photoImg"),
    photoFallback: $("photoFallback"),
    counter: $("counterPill"),
    fsBtn: $("fsBtn"),
    exitBtn: $("exitBtn"),
  };

  const kflEl = {
    root: document.getElementById("kflRoot"),
    defaultRoot: document.getElementById("defaultRoot"),
    tplTag: document.getElementById("tplTag"),
    name: document.getElementById("kflName"),
    school: document.getElementById("kflSchoolLine"),
    height: document.getElementById("kflHeightLine"),
    weight: document.getElementById("kflWeightLine"),
    perf: document.getElementById("kflPerf"),
    photoImg: document.getElementById("kflPhotoImg"),
    photoFallback: document.getElementById("kflPhotoFallback"),
  };

  function applyTemplateFromHash(){
    const tpl = (getHashParam("tpl") || "default").toLowerCase();
    const isKfl = tpl === "kfl";
    if (kflEl.tplTag) kflEl.tplTag.style.display = isKfl ? "inline-flex" : "none";
    if (kflEl.root) kflEl.root.style.display = isKfl ? "block" : "none";
    if (kflEl.defaultRoot) kflEl.defaultRoot.style.display = isKfl ? "none" : "block";
    return tpl;
  }


  function esc(s){
    return String(s ?? "—")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function pick(obj, keys){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== "") return obj[k];
    }
    return "";
  }

  function initials(name){
    const s = String(name||"").trim();
    if(!s) return "—";
    const p = s.split(/\s+/);
    return ((p[0]?.[0]||"") + (p[p.length-1]?.[0]||"")).toUpperCase();
  }

  function padId(v){
    const s = String(v ?? "").trim();
    if(!s) return "";
    return s.padStart(3, "0");
  }

  function normId(v){
    const s = String(v ?? "").trim();
    if(!s) return "";
    return s.replace(/^0+/, "") || "0";
  }

  function getSel(){
    const h = window.location.hash || "";
    const m = h.match(/#sel=([^&]+)/i);
    return m ? decodeURIComponent(m[1]) : "";
  }

  function setPhoto(url, name){
    if(!el.photoImg) return;

    if(el.photoFallback){
      el.photoFallback.textContent = initials(name);
      el.photoFallback.style.display = "flex";
    }
    el.photoImg.style.display = "none";

    const token = Date.now() + Math.random();
    el.photoImg.dataset.token = token;

    el.photoImg.onload = () => {
      if(el.photoImg.dataset.token != token) return;
      if(el.photoFallback) el.photoFallback.style.display = "none";
      el.photoImg.style.display = "block";
    };

    el.photoImg.onerror = () => {
      if(el.photoImg.dataset.token != token) return;
      if(el.photoFallback){
        el.photoFallback.textContent = initials(name);
        el.photoFallback.style.display = "flex";
      }
      el.photoImg.style.display = "none";
    };

    el.photoImg.src = url;
  }

  function render(r, selRaw){
    const name = pick(r, ["Nombre","Name","Athlete","Player"]) || "—";
    const pos  = pick(r, ["Pos","Position","Posición"]) || "";
    const sport = pick(r, ["Sport","Deporte"]) || "";
    const team = pick(r, ["Team","Equipo"]) || "";

    // Core fields
    const age = pick(r, ["Edad","Age","age"]) || "";
    const height = pick(r, ["Estatura","Altura","Height","Ht","height"]) || "";
    const weight = pick(r, ["Peso","Weight","Wt","weight"]) || "";

    if(el.name) el.name.innerHTML = esc(name);
    if(el.meta) el.meta.innerHTML = [sport,pos,team].filter(Boolean).map(esc).join(" • ") || "&nbsp;";
    if(el.counter) el.counter.textContent = selRaw ? `#${selRaw}` : "";

    // School (non-negotiable)
    const school = pick(r, ["Lugar de Estudios","Lugar de estudios","Lugar_de_Estudios","School","Escuela","Colegio","school"]) || "";
    if(el.school) el.school.innerHTML = school ? esc(school) : "—";

    // Helpers to compute "best" from multiple columns if needed
    function toNumber(v){
      if(v === undefined || v === null) return null;
      const s = String(v).replace(/,/g,".").trim();
      const mm = s.match(/-?\d+(?:\.\d+)?/);
      if(!mm) return null;
      const n = parseFloat(mm[0]);
      return Number.isFinite(n) ? n : null;
    }

    function formatTime(raw){
      const s = String(raw ?? "").trim();
      if(!s) return "";
      if(/[a-zA-Z]/.test(s)) return s;
      const n = toNumber(s);
      if(n === null) return s;
      return n.toFixed(2);
    }

    function formatNumber(raw, decimals){
      const s = String(raw ?? "").trim();
      if(!s) return "";
      if(/[a-zA-Z]/.test(s)) return s;
      const n = toNumber(s);
      if(n === null) return s;
      return (decimals === 0) ? String(Math.round(n)) : n.toFixed(decimals);
    }

    function addUnit(raw, unit){
      const s = String(raw ?? "").trim();
      if(!s) return "";
      const lower = s.toLowerCase();
      // If already contains unit or non-numeric suffix, don't append
      if(lower.includes(unit.toLowerCase())) return s;
      // If it contains any letters (like 'sec', 'in', 'reps') assume unit present
      if(/[a-zA-Z]/.test(s)) return s;
      return s + " " + unit;
    }

    function statCard(label, value){
      const vv = String(value ?? "").trim();
      const show = vv ? vv : "—";
      return `<div class="stat"><div class="k">${esc(label)}</div><div class="v">${esc(show)}</div></div>`;
    }

    function bestFromRow(regex, mode){
      let bestVal = null;
      let bestRaw = "";
      for(const k of Object.keys(r)){
        if(!regex.test(k)) continue;
        const raw = r[k];
        const n = toNumber(raw);
        if(n === null) continue;
        const rawS = String(raw ?? "").trim();
        if(bestVal === null){
          bestVal = n; bestRaw = rawS;
        }else{
          if(mode === "min" && n < bestVal){ bestVal = n; bestRaw = rawS; }
          if(mode === "max" && n > bestVal){ bestVal = n; bestRaw = rawS; }
        }
      }
      return bestRaw;
    }

    function bestExplicit(keys){
      for(const k of keys){
        if(Object.prototype.hasOwnProperty.call(r, k) && String(r[k]??"").trim() !== ""){
          return String(r[k]).trim();
        }
      }
      return "";
    }

    // Best results (Coach-profile style)
    // 40 YDS DASH (SEGUNDOS) — best of attempts (includes "2da Vuelta")
    const best40 = bestExplicit([
      "40 YDS DASH (SEGUNDOS)",
      "40 YDS DASH (SEGUNDOS) 2da Vuelta",
      "40yds","40 yds","40yd","40 yd","40","40 Time","Tiempo 40","Tiempo_40",
      "40yds (s)","40yd (s)","Tiempo 40yd","Tiempo 40 yds"
    ]) || bestFromRow(/40\s*YDS\s*DASH\s*\(SEGUNDOS\)|40\s*yds?\s*dash|40\s*yds?|forty|tiempo\s*40/i, "min");

    const bestBroad = bestExplicit(["Broad Jump","Salto Largo","Salto","Best Broad","Best Broad Jump","Best Broad jump","Broad Jump Best","BestBroad"]) ||
                      bestFromRow(/(^|\b)(broad\s*jump|broad)(\b|$)/i, "max");

    const best5105 = bestExplicit(["5-10-5","5 10 5","Pro Shuttle","Shuttle","Tiempo 5-10-5","Best 5-10-5","Best 5-10-5 (Pro Shuttle)","Best Pro Shuttle","Best Shuttle","5-10-5 Best","Pro Shuttle Best","Best5105"]) ||
                     bestFromRow(/(^|\b)(5\s*-\s*10\s*-\s*5|5\s*10\s*5|5105|pro\s*shuttle|shuttle)(\b|$)/i, "min");

    // 3- CONE DRILL — best of attempts (includes "2da Vuelta")
    const best3Cone = bestExplicit([
      "3- CONE DRILL",
      "3- CONE DRILL 2da Vuelta",
      "3-Cone","3 Cone","3Cone","Cone","Tiempo 3-Cone","Tiempo_3_Cone",
      "Best 3-cone","Best 3 Cone","Best 3Cone","3-cone Best","3Cone Best","Best3Cone"
    ]) || bestFromRow(/3\s*-\s*CONE\s*DRILL|3\s*-?\s*cone|3cone|three\s*cone|cone/i, "min");

    const bestBench = bestExplicit(["Bench","Bench Press","Press Banca","Banca","BP","Reps Bench","Best Bench","Best Bench Press","Best BP","Bench Best","BP Best","BestBench"]) ||
                      bestFromRow(/(^|\b)(bench|bench\s*press|bp|press\s*reps|reps)(\b|$)/i, "max");

    const cards = [];
    cards.push(statCard("Age", age));
    cards.push(statCard("Height", height));
    cards.push(statCard("Weight", String(weight).trim() ? (String(weight).trim() + " lbs") : ""));

    if(best40) cards.push(statCard("40yds", addUnit(formatTime(best40), "s")));
    if(bestBroad) cards.push(statCard("Broad Jump", addUnit(formatNumber(bestBroad, 0), "in")));
    if(best5105) cards.push(statCard("5-10-5", addUnit(formatTime(best5105), "s")));
    if(best3Cone) cards.push(statCard("3-Cone", addUnit(formatTime(best3Cone), "s")));
    if(bestBench) cards.push(statCard("Bench", addUnit(formatNumber(bestBench, 0), "reps")));

    if(el.stats) el.stats.innerHTML = cards.join("");

    // Photo via CDN
    const idRaw = pick(r, ["Formulario#","Formulario","ID","Id","id"]);
    if(idRaw){
      const url = PHOTO_BASE_URL + padId(idRaw) + ".jpg";
      setPhoto(url, name);
    }else{
      if(el.photoFallback){
        el.photoFallback.textContent = initials(name);
        el.photoFallback.style.display = "flex";
      }
      if(el.photoImg) el.photoImg.style.display = "none";
    }
  }


  function renderKfl(r, selRaw){
    const name = pick(r, ["Nombre","Name","Athlete","Player"]) || "—";
    const school = pick(r, ["Lugar de Estudios","Lugar de estudios","Lugar_de_Estudios","School","Escuela","Colegio","school"]) || "";
    const height = pick(r, ["Estatura","Altura","Height","Ht","height"]) || "";
    const weight = pick(r, ["Peso","Weight","Wt","weight"]) || "";

    if (kflEl.name) kflEl.name.textContent = name;
    if (kflEl.school) kflEl.school.textContent = "COLEGIO: " + (school || "—");
    if (kflEl.height) kflEl.height.textContent = "ESTATURA: " + (height || "—");
    if (kflEl.weight){
      const w = String(weight||"").trim();
      kflEl.weight.textContent = "PESO: " + (w ? (w + " LBS") : "—");
    }

    function toNumber(v){
      if(v === undefined || v === null) return null;
      const s = String(v).replace(/,/g,".").trim();
      const mm = s.match(/-?\d+(?:\.\d+)?/);
      if(!mm) return null;
      const n = parseFloat(mm[0]);
      return Number.isFinite(n) ? n : null;
    }
    function formatTime(raw){
      const s = String(raw ?? "").trim();
      if(!s) return "";
      const n = toNumber(s);
      if(n === null) return s;
      return n.toFixed(2);
    }
    function formatNumber(raw, decimals){
      const s = String(raw ?? "").trim();
      if(!s) return "";
      const n = toNumber(s);
      if(n === null) return s;
      return (decimals === 0) ? String(Math.round(n)) : n.toFixed(decimals);
    }
    function bestExplicit(keys){
      for(const k of keys){
        if(Object.prototype.hasOwnProperty.call(r, k) && String(r[k]??"").trim() !== ""){
          return String(r[k]).trim();
        }
      }
      return "";
    }
    function bestFromRow(regex, mode){
      let bestVal = null;
      let bestRaw = "";
      for(const k of Object.keys(r)){
        if(!regex.test(k)) continue;
        const raw = r[k];
        const n = toNumber(raw);
        if(n === null) continue;
        const rawS = String(raw ?? "").trim();
        if(bestVal === null){
          bestVal = n; bestRaw = rawS;
        }else{
          if(mode === "min" && n < bestVal){ bestVal = n; bestRaw = rawS; }
          if(mode === "max" && n > bestVal){ bestVal = n; bestRaw = rawS; }
        }
      }
      return bestRaw;
    }

    const best40 = bestExplicit([
      "40 YDS DASH (SEGUNDOS)",
      "40 YDS DASH (SEGUNDOS) 2da Vuelta",
    ]) || bestFromRow(/40\s*YDS\s*DASH\s*\(SEGUNDOS\)/i, "min");

    const bestBroad = bestExplicit([
      "BROAD JUMP (PULGADAS)",
      "BROAD JUMP (PULGADAS) 2da Vuelta",
    ]) || bestFromRow(/BROAD\s*JUMP\s*\(PULGADAS\)/i, "max");

    const best5105 = bestExplicit([
      "5-10-5 (SHUTTLE) RUN",
      "5-10-5 (SHUTTLE) RUN 2da Vuelta",
    ]) || bestFromRow(/5\-10\-5\s*\(SHUTTLE\)\s*RUN/i, "min");

    const best3Cone = bestExplicit([
      "3- CONE DRILL",
      "3- CONE DRILL 2da Vuelta",
    ]) || bestFromRow(/3\-\s*CONE\s*DRILL/i, "min");

    const bestBench = bestExplicit([
      "BENCHPRESS",
      "BENCH PRESS 2da Vuelta ",
    ]) || bestFromRow(/BENCH/i, "max");

    function perfCell(label, value){
      const v = String(value||"").trim() || "—";
      return `<div class="cell"><div class="label">${esc(label)}</div><div class="value">${esc(v)}</div></div>`;
    }

    const cells = [];
    cells.push(perfCell("40 YARDS<br>DASH", best40 ? formatTime(best40) : "—"));
    cells.push(perfCell("5-10-5<br>SHUTTLE", best5105 ? formatTime(best5105) : "—"));
    cells.push(perfCell("3-CONE<br>DRILL", best3Cone ? formatTime(best3Cone) : "—"));
    cells.push(perfCell("LONG<br>JUMP", bestBroad ? formatNumber(bestBroad, 0) + '"' : "—"));
    cells.push(perfCell("BENCH<br>PRESS", bestBench ? formatNumber(bestBench, 0) : "—"));
    if (kflEl.perf) kflEl.perf.innerHTML = cells.join("");

    // Photo CDN
    const idRaw = pick(r, ["Formulario#","Formulario","ID","Id","id"]);
    const url = idRaw ? (PHOTO_BASE_URL + padId(idRaw) + ".jpg") : "";
    if (url){
      if (kflEl.photoImg){
        kflEl.photoImg.onload = ()=>{
          kflEl.photoImg.style.display = "block";
          if (kflEl.photoFallback) kflEl.photoFallback.style.display = "none";
        };
        kflEl.photoImg.onerror = ()=>{
          if (kflEl.photoFallback){
            kflEl.photoFallback.textContent = initials(name);
            kflEl.photoFallback.style.display = "flex";
          }
          if (kflEl.photoImg) kflEl.photoImg.style.display = "none";
        };
        kflEl.photoImg.src = url;
        kflEl.photoImg.alt = name;
      }
    }else{
      if (kflEl.photoFallback){
        kflEl.photoFallback.textContent = initials(name);
        kflEl.photoFallback.style.display = "flex";
      }
      if (kflEl.photoImg) kflEl.photoImg.style.display = "none";
    }
  }

  function parseCsv(text){
    const rows = [];
    let i=0,f="",row=[],q=false;
    const pf=()=>{row.push(f);f="";};
    const pr=()=>{rows.push(row);row=[];};
    while(i<text.length){
      const c=text[i];
      if(q){
        if(c=='"' && text[i+1]=='"'){f+='"';i+=2;continue;}
        if(c=='"'){q=false;i++;continue;}
        f+=c;i++;continue;
      }
      if(c=='"'){q=true;i++;continue;}
      if(c==','){pf();i++;continue;}
      if(c=='\n'){pf();pr();i++;continue;}
      if(c=='\r'){i++;continue;}
      f+=c;i++;
    }
    pf(); if(row.length) pr();
    const h=rows.shift();
    return rows.map(r=>Object.fromEntries(h.map((k,i)=>[k,r[i]||""])));
  }

  async function loadCsv(){
    const dir = window.location.origin + window.location.pathname.replace(/[^\/]*$/, "");
    const res = await fetch(new URL("./results.csv", dir), { cache:"no-store" });
    if(!res.ok) throw new Error("results.csv not found");
    return parseCsv(await res.text());
  }

  let csv=null, lastSel="";
  async function hydrate(){
    const sel = getSel();
    if(!sel || sel===lastSel) return;
    lastSel=sel;
    if(!csv) csv = await loadCsv();
    const selN = normId(sel);
    const row = csv.find(r => normId(pick(r,["Formulario#","Formulario","ID","Id","id"])) === selN);
    if(row) ( (getHashParam("tpl")||"default").toLowerCase()==="kfl" ? renderKfl(row, sel) : render(row, sel) );
  }

  el.fsBtn?.addEventListener("click", async()=>{
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  el.exitBtn?.addEventListener("click", ()=>{ try{ window.close(); }catch(e){} });

  window.addEventListener("hashchange", hydrate);
  hydrate();
})();
</script>


</body>
</html>
