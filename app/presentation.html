<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Presentation Mode — Athlete Combine Dashboard</title>
<style>
  :root{
    --bg:#070b16;
    --panel: rgba(255,255,255,.06);
    --border: rgba(255,255,255,.14);
    --text:#eef3ff;
    --muted:#a7b3d6;
    --accent:#51CAF5;
    --accent2:#5471B7;
    --radius:18px;
    --shadow: 0 20px 70px rgba(0,0,0,.55);
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:var(--font);
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(81,202,245,.16), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(84,113,183,.18), transparent 60%),
      var(--bg);
    overflow:hidden;
  }

  .wrap{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr;
  }

  .topbar{
    padding: 14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    background: linear-gradient(to bottom, rgba(7,11,22,.88), rgba(7,11,22,.55));
    backdrop-filter: blur(10px);
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:4px;
    min-width: 220px;
  }
  .brand .title{
    font-weight: 800;
    letter-spacing: .2px;
    font-size: 16px;
    margin:0;
  }
  .brand .sub{
    color: var(--muted);
    font-size: 12px;
  }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .btn{
    appearance:none;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    font-size: 13px;
    line-height:1;
    user-select:none;
  }
  .btn:hover{ border-color: rgba(81,202,245,.35); }
  .btn:active{ transform: translateY(1px); }
  .btnGhost{ background: transparent; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border:1px solid rgba(255,255,255,.18);
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    background: rgba(255,255,255,.06);
  }

  .stage{
    padding: 18px;
    display:grid;
    place-items:center;
  }
  .card{
    width: min(1100px, 100%);
    border: 1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardInner{
    padding: 22px;
    display:grid;
    grid-template-columns: 340px 1fr;
    gap: 18px;
  }

  .photo{
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    background: rgba(0,0,0,.18);
    overflow:hidden;
    min-height: 360px;
    display:flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.45);
    position:relative;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit: cover;
    display:block;
  }

  .name{
    font-size: 40px;
    font-weight: 900;
    letter-spacing: .2px;
    margin:0 0 10px 0;
  }
  .metaRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom: 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }
  .stat{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    border-radius: 14px;
    padding: 12px;
  }
  .stat .k{
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 6px;
  }
  .stat .v{
    font-size: 18px;
    font-weight: 800;
    letter-spacing: .2px;
  }

  .footerHint{
    padding: 12px 18px;
    border-top: 1px solid rgba(255,255,255,.10);
    color: var(--muted);
    font-size: 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }

  @media (max-width: 900px){
    .cardInner{ grid-template-columns: 1fr; }
    .photo{ min-height: 260px; }
    .name{ font-size: 32px; }
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 520px){
    .stage{ padding: 12px; }
    .cardInner{ padding: 14px; }
    .name{ font-size: 26px; }
    .grid{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1 class="title">Presentation Mode</h1>
        <div class="sub">Arrow keys: Prev/Next • F: Fullscreen • Esc: Exit fullscreen</div>
      </div>
      <div class="actions">
        <span class="pill" id="counterPill">— / —</span>
        <button class="btn" id="prevBtn" type="button">Prev</button>
        <button class="btn" id="nextBtn" type="button">Next</button>
        <button class="btn btnGhost" id="fsBtn" type="button">Fullscreen</button>
        <button class="btn btnGhost" id="exitBtn" type="button">Exit</button>
      </div>
    </div>

    <div class="stage">
      <div class="card" role="region" aria-label="Presentation card">
        <div class="cardInner">
          <div class="photo">
            <img id="photoImg" alt="" style="display:none"/>
            <div id="photoFallback">No photo</div>
          </div>

          <div>
            <h2 class="name" id="name">—</h2>
            <div class="metaRow" id="metaRow"></div>

            <div class="grid" id="stats"></div>
          </div>
        </div>

        <div class="footerHint">
          <div id="school">—</div>
          <div id="location">—</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const PRES_KEY = "ac_presenter_current_athlete";

  const el = {
    name: $("pName"),
    meta: $("pMeta"),
    stats: $("pStats"),
    notes: $("pNotes"),
    photo: $("pPhoto"),
    hint: $("pHint"),
    btnFullscreen: $("btnFullscreen"),
  };

  function esc(s){
    return String(s ?? "—")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function pick(obj, keys){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== "") return obj[k];
    }
    return "";
  }

  function setPhotoFromUrl(url){
    if(!el.photo) return;
    if(!url){
      el.photo.style.backgroundImage = "";
      el.photo.setAttribute("data-empty","1");
      return;
    }
    el.photo.style.backgroundImage = `url('${url}')`;
    el.photo.removeAttribute("data-empty");
  }

  function trySetPhoto(r){
    const direct = r && (r._photoUrl || r.photoUrl || r.PhotoUrl);
    if(direct){ setPhotoFromUrl(direct); return; }

    const id = pick(r, ["Formulario#", "Formulario", "ID", "Id", "id"]);
    const candidates = [
      `photos/${id}.jpg`,
      `photos/${id}.jpeg`,
      `photos/${id}.png`,
      `photos/${id}.webp`,
    ].filter(x => id);

    if(!candidates.length){ setPhotoFromUrl(""); return; }

    let i = 0;
    const img = new Image();
    const loadNext = () => {
      if(i >= candidates.length){ setPhotoFromUrl(""); return; }
      img.onload = () => setPhotoFromUrl(candidates[i]);
      img.onerror = () => { i++; loadNext(); };
      img.src = candidates[i];
    };
    loadNext();
  }

  function renderAthlete(r){
    if(!r) return;
    if(el.hint) el.hint.style.display = "none";

    const name = pick(r, ["Nombre", "Name", "Athlete", "athlete", "Player", "player"]) || "—";
    const pos  = pick(r, ["Pos", "Position", "Posición", "position"]) || "—";
    const sport = pick(r, ["Sport", "Deporte", "sport"]) || "—";
    const age = pick(r, ["Age", "Edad", "age"]) || "—";
    const team = pick(r, ["Team", "Equipo", "team"]) || "—";

    if(el.name) el.name.innerHTML = esc(name);
    if(el.meta) el.meta.innerHTML = `${esc(sport)} • ${esc(pos)} • ${esc(team)}`;
    if(el.stats) el.stats.innerHTML = `<span class="stat"><span class="k">Age</span><span class="v">${esc(age)}</span></span>`;

    const notes = pick(r, ["Notas", "Notes", "notes"]) || "";
    if(el.notes) el.notes.innerHTML = notes ? esc(notes) : "—";

    trySetPhoto(r);
  }

  function tryLoadFromStorage(){
    try{
      const raw = localStorage.getItem(PRES_KEY);
      if(!raw) return false;
      const payload = JSON.parse(raw);
      if(payload?.type === "ac_athlete_update" && payload?.athlete){
        renderAthlete(payload.athlete);
        return true;
      }
    }catch(e){}
    return false;
  }

  async function toggleFullscreen(){
    try{
      if(!document.fullscreenElement){
        await document.documentElement.requestFullscreen();
      }else{
        await document.exitFullscreen();
      }
    }catch(e){}
  }

  el.btnFullscreen?.addEventListener("click", toggleFullscreen);
  window.addEventListener("keydown", (e) => {
    if(e.key === "f" || e.key === "F") toggleFullscreen();
  });

  // postMessage updates
  window.addEventListener("message", (e) => {
    if(e?.data?.type === "ac_athlete_update" && e?.data?.athlete){
      renderAthlete(e.data.athlete);
    }
  });

  // BroadcastChannel updates
  let ch = null;
  try{
    if ("BroadcastChannel" in window){
      ch = new BroadcastChannel("ac_presenter_channel");
      ch.addEventListener("message", (ev) => {
        if(ev?.data?.type === "ac_athlete_update" && ev?.data?.athlete){
          renderAthlete(ev.data.athlete);
        }
      });
    }
  }catch(e){}

  // localStorage updates across tabs
  window.addEventListener("storage", (ev) => {
    if(ev.key === PRES_KEY){
      tryLoadFromStorage();
    }
  });

  // Handshake + request current athlete
  try{
    if(window.opener){
      window.opener.postMessage({ type: "ac_presentation_ready" }, "*");
      window.opener.postMessage({ type: "ac_request_current_athlete" }, "*");
    }
  }catch(e){}
  try{ ch?.postMessage({ type: "ac_request_current_athlete" }); }catch(e){}

  const had = tryLoadFromStorage();

  if(el.hint){
    el.hint.style.display = had ? "none" : "block";
    el.hint.textContent = "Waiting for selection… (Pick an athlete in the dashboard)";
  }
})();
</script>

</body>
</html>
