<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Presentation Mode — Athlete Combine Dashboard</title>
<style>
  :root{
    --bg:#070b16;
    --panel: rgba(255,255,255,.06);
    --border: rgba(255,255,255,.14);
    --text:#eef3ff;
    --muted:#a7b3d6;
    --accent:#51CAF5;
    --accent2:#5471B7;
    --radius:18px;
    --shadow: 0 20px 70px rgba(0,0,0,.55);
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:var(--font);
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(81,202,245,.16), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(84,113,183,.18), transparent 60%),
      var(--bg);
    overflow:hidden;
  }

  .wrap{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr;
  }

  .topbar{
    padding: 14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    background: linear-gradient(to bottom, rgba(7,11,22,.88), rgba(7,11,22,.55));
    backdrop-filter: blur(10px);
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:4px;
    min-width: 220px;
  }
  .brand .title{
    font-weight: 800;
    letter-spacing: .2px;
    font-size: 16px;
    margin:0;
  }
  .brand .sub{
    color: var(--muted);
    font-size: 12px;
  }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .btn{
    appearance:none;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    font-size: 13px;
    line-height:1;
    user-select:none;
  }
  .btn:hover{ border-color: rgba(81,202,245,.35); }
  .btn:active{ transform: translateY(1px); }
  .btnGhost{ background: transparent; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border:1px solid rgba(255,255,255,.18);
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    background: rgba(255,255,255,.06);
  }

  .stage{
    padding: 18px;
    display:grid;
    place-items:center;
  }
  .card{
    width: min(1100px, 100%);
    border: 1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardInner{
    padding: 22px;
    display:grid;
    grid-template-columns: 340px 1fr;
    gap: 18px;
  }

  .photo{
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    background: rgba(0,0,0,.18);
    overflow:hidden;
    min-height: 360px;
    display:flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.45);
    position:relative;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit: cover;
    display:block;
  }

  .name{
    font-size: 40px;
    font-weight: 900;
    letter-spacing: .2px;
    margin:0 0 10px 0;
  }
  .metaRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom: 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }
  .stat{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    border-radius: 14px;
    padding: 12px;
  }
  .stat .k{
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 6px;
  }
  .stat .v{
    font-size: 18px;
    font-weight: 800;
    letter-spacing: .2px;
  }

  .footerHint{
    padding: 12px 18px;
    border-top: 1px solid rgba(255,255,255,.10);
    color: var(--muted);
    font-size: 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }

  @media (max-width: 900px){
    .cardInner{ grid-template-columns: 1fr; }
    .photo{ min-height: 260px; }
    .name{ font-size: 32px; }
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 520px){
    .stage{ padding: 12px; }
    .cardInner{ padding: 14px; }
    .name{ font-size: 26px; }
    .grid{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1 class="title">Presentation Mode</h1>
        <div class="sub">Arrow keys: Prev/Next • F: Fullscreen • Esc: Exit fullscreen</div>
      </div>
      <div class="actions">
        <span class="pill" id="counterPill">— / —</span>
        <button class="btn" id="prevBtn" type="button">Prev</button>
        <button class="btn" id="nextBtn" type="button">Next</button>
        <button class="btn btnGhost" id="fsBtn" type="button">Fullscreen</button>
        <button class="btn btnGhost" id="exitBtn" type="button">Exit</button>
      </div>
    </div>

    <div class="stage">
      <div class="card" role="region" aria-label="Presentation card">
        <div class="cardInner">
          <div class="photo">
            <img id="photoImg" alt="" style="display:none"/>
            <div id="photoFallback">No photo</div>
          </div>

          <div>
            <h2 class="name" id="name">—</h2>
            <div class="metaRow" id="metaRow"></div>

            <div class="grid" id="stats"></div>
          </div>
        </div>

        <div class="footerHint">
          <div id="school">—</div>
          <div id="location">—</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const PHOTO_BASE_URL = "https://media.kkmsports.xyz/athletes/";

  const $ = (id)=>document.getElementById(id);

  const el = {
    name: $("name"),
    meta: $("metaRow"),
    stats: $("stats"),
    school: $("school"),
    location: $("location"),
    photoImg: $("photoImg"),
    photoFallback: $("photoFallback"),
    counter: $("counterPill"),
    fsBtn: $("fsBtn"),
    exitBtn: $("exitBtn"),
  };

  function esc(s){
    return String(s ?? "—")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function pick(obj, keys){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== "") return obj[k];
    }
    return "";
  }

  function initials(name){
    const s = String(name||"").trim();
    if(!s) return "—";
    const p = s.split(/\s+/);
    return ((p[0]?.[0]||"") + (p[p.length-1]?.[0]||"")).toUpperCase();
  }

  function padId(v){
    const s = String(v ?? "").trim();
    if(!s) return "";
    return s.padStart(3, "0");
  }

  function normId(v){
    const s = String(v ?? "").trim();
    if(!s) return "";
    return s.replace(/^0+/, "") || "0";
  }

  function getSel(){
    const h = window.location.hash || "";
    const m = h.match(/#sel=([^&]+)/i);
    return m ? decodeURIComponent(m[1]) : "";
  }

  function setPhoto(url, name){
    if(!el.photoImg) return;

    if(el.photoFallback){
      el.photoFallback.textContent = initials(name);
      el.photoFallback.style.display = "flex";
    }
    el.photoImg.style.display = "none";

    const token = Date.now() + Math.random();
    el.photoImg.dataset.token = token;

    el.photoImg.onload = () => {
      if(el.photoImg.dataset.token != token) return;
      if(el.photoFallback) el.photoFallback.style.display = "none";
      el.photoImg.style.display = "block";
    };

    el.photoImg.onerror = () => {
      if(el.photoImg.dataset.token != token) return;
      if(el.photoFallback){
        el.photoFallback.textContent = initials(name);
        el.photoFallback.style.display = "flex";
      }
      el.photoImg.style.display = "none";
    };

    el.photoImg.src = url;
  }

  function render(r, selRaw){
    const name = pick(r, ["Nombre","Name","Athlete","Player"]) || "—";
    const pos  = pick(r, ["Pos","Position","Posición"]) || "";
    const sport = pick(r, ["Sport","Deporte"]) || "";
    const team = pick(r, ["Team","Equipo"]) || "";

    // Core fields
    const age = pick(r, ["Edad","Age","age"]) || "";
    const height = pick(r, ["Estatura","Altura","Height","Ht","height"]) || "";
    const weight = pick(r, ["Peso","Weight","Wt","weight"]) || "";

    if(el.name) el.name.innerHTML = esc(name);
    if(el.meta) el.meta.innerHTML = [sport,pos,team].filter(Boolean).map(esc).join(" • ") || "&nbsp;";
    if(el.counter) el.counter.textContent = selRaw ? `#${selRaw}` : "";

    // School (non-negotiable)
    const school = pick(r, ["Lugar de Estudios","Lugar de estudios","Lugar_de_Estudios","School","Escuela","Colegio","school"]) || "";
    if(el.school) el.school.innerHTML = school ? esc(school) : "—";

    // Helpers to compute "best" from multiple columns if needed
    function toNumber(v){
      if(v === undefined || v === null) return null;
      const s = String(v).replace(/,/g,".").trim();
      const mm = s.match(/-?\d+(?:\.\d+)?/);
      if(!mm) return null;
      const n = parseFloat(mm[0]);
      return Number.isFinite(n) ? n : null;
    }

    function addUnit(raw, unit){
      const s = String(raw ?? "").trim();
      if(!s) return "";
      const lower = s.toLowerCase();
      // If already contains unit or non-numeric suffix, don't append
      if(lower.includes(unit.toLowerCase())) return s;
      // If it contains any letters (like 'sec', 'in', 'reps') assume unit present
      if(/[a-zA-Z]/.test(s)) return s;
      return s + " " + unit;
    }

    function statCard(label, value){
      const vv = String(value ?? "").trim();
      if(!vv) return "";
      return `<div class="stat"><div class="k">${esc(label)}</div><div class="v">${esc(vv)}</div></div>`;
    }

    function bestFromRow(regex, mode){
      let bestVal = null;
      let bestRaw = "";
      for(const k of Object.keys(r)){
        if(!regex.test(k)) continue;
        const raw = r[k];
        const n = toNumber(raw);
        if(n === null) continue;
        const rawS = String(raw ?? "").trim();
        if(bestVal === null){
          bestVal = n; bestRaw = rawS;
        }else{
          if(mode === "min" && n < bestVal){ bestVal = n; bestRaw = rawS; }
          if(mode === "max" && n > bestVal){ bestVal = n; bestRaw = rawS; }
        }
      }
      return bestRaw;
    }

    function bestExplicit(keys){
      for(const k of keys){
        if(Object.prototype.hasOwnProperty.call(r, k) && String(r[k]??"").trim() !== ""){
          return String(r[k]).trim();
        }
      }
      return "";
    }

    // Best results (Coach-profile style)
    const best40 = bestExplicit(["40yds","40 yds","40yd","40 yd","40","40 Time","Tiempo 40","Best 40","Best 40yd","Best 40yd dash","Best 40yd Dash","40yd Best","Best40"]) ||
                  bestFromRow(/(^|\b)(40\s*yd|40yd|forty|40\s*dash|40yd\s*dash)(\b|$)/i, "min");

    const bestBroad = bestExplicit(["Broad Jump","Salto Largo","Salto","Best Broad","Best Broad Jump","Best Broad jump","Broad Jump Best","BestBroad"]) ||
                      bestFromRow(/(^|\b)(broad\s*jump|broad)(\b|$)/i, "max");

    const best5105 = bestExplicit(["5-10-5","5 10 5","Pro Shuttle","Shuttle","Tiempo 5-10-5","Best 5-10-5","Best 5-10-5 (Pro Shuttle)","Best Pro Shuttle","Best Shuttle","5-10-5 Best","Pro Shuttle Best","Best5105"]) ||
                     bestFromRow(/(^|\b)(5\s*-\s*10\s*-\s*5|5\s*10\s*5|5105|pro\s*shuttle|shuttle)(\b|$)/i, "min");

    const best3Cone = bestExplicit(["3-Cone","3 Cone","3Cone","Cone","Tiempo 3-Cone","Best 3-cone","Best 3 Cone","Best 3Cone","3-cone Best","3Cone Best","Best3Cone"]) ||
                      bestFromRow(/(^|\b)(3\s*-?\s*cone|3cone|three\s*cone|cone)(\b|$)/i, "min");

    const bestBench = bestExplicit(["Bench","Bench Press","Press Banca","Banca","BP","Reps Bench","Best Bench","Best Bench Press","Best BP","Bench Best","BP Best","BestBench"]) ||
                      bestFromRow(/(^|\b)(bench|bench\s*press|bp|press\s*reps|reps)(\b|$)/i, "max");

    const cards = [];
    if(age) cards.push(statCard("Age", age));
    if(height) cards.push(statCard("Height", height));
    if(weight) cards.push(statCard("Weight", String(weight).trim() ? (String(weight).trim() + " lbs") : ""));

    if(best40) cards.push(statCard("40yds", addUnit(best40, "s")));
    if(bestBroad) cards.push(statCard("Broad Jump", addUnit(bestBroad, "in")));
    if(best5105) cards.push(statCard("5-10-5", addUnit(best5105, "s")));
    if(best3Cone) cards.push(statCard("3-Cone", addUnit(best3Cone, "s")));
    if(bestBench) cards.push(statCard("Bench", addUnit(bestBench, "reps")));

    if(el.stats) el.stats.innerHTML = cards.join("") || "&nbsp;";

    // Photo via CDN
    const idRaw = pick(r, ["Formulario#","Formulario","ID","Id","id"]);
    if(idRaw){
      const url = PHOTO_BASE_URL + padId(idRaw) + ".jpg";
      setPhoto(url, name);
    }else{
      if(el.photoFallback){
        el.photoFallback.textContent = initials(name);
        el.photoFallback.style.display = "flex";
      }
      if(el.photoImg) el.photoImg.style.display = "none";
    }
  }

  function parseCsv(text){
    const rows = [];
    let i=0,f="",row=[],q=false;
    const pf=()=>{row.push(f);f="";};
    const pr=()=>{rows.push(row);row=[];};
    while(i<text.length){
      const c=text[i];
      if(q){
        if(c=='"' && text[i+1]=='"'){f+='"';i+=2;continue;}
        if(c=='"'){q=false;i++;continue;}
        f+=c;i++;continue;
      }
      if(c=='"'){q=true;i++;continue;}
      if(c==','){pf();i++;continue;}
      if(c=='\n'){pf();pr();i++;continue;}
      if(c=='\r'){i++;continue;}
      f+=c;i++;
    }
    pf(); if(row.length) pr();
    const h=rows.shift();
    return rows.map(r=>Object.fromEntries(h.map((k,i)=>[k,r[i]||""])));
  }

  async function loadCsv(){
    const dir = window.location.origin + window.location.pathname.replace(/[^\/]*$/, "");
    const res = await fetch(new URL("./results.csv", dir), { cache:"no-store" });
    if(!res.ok) throw new Error("results.csv not found");
    return parseCsv(await res.text());
  }

  let csv=null, lastSel="";
  async function hydrate(){
    const sel = getSel();
    if(!sel || sel===lastSel) return;
    lastSel=sel;
    if(!csv) csv = await loadCsv();
    const selN = normId(sel);
    const row = csv.find(r => normId(pick(r,["Formulario#","Formulario","ID","Id","id"])) === selN);
    if(row) render(row, sel);
  }

  el.fsBtn?.addEventListener("click", async()=>{
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  el.exitBtn?.addEventListener("click", ()=>{ try{ window.close(); }catch(e){} });

  window.addEventListener("hashchange", hydrate);
  hydrate();
})();
</script>


</body>
</html>
