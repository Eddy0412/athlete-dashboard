<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Athlete Combine Dashboard</title>

  <!-- Libraries (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a27;
      --muted:#8aa0b6;
      --text:#e8f0ff;
      --line:#1e2a3c;
      --accent:#09a7d4;
      --accent2:#5471b7;
      --good:#3ddc97;
      --bad:#ff6b6b;
      --warn:#ffd166;
      --radius:16px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html, body{overflow-x:hidden;}
    body{margin:0;background:radial-gradient(1200px 800px at 20% 10%, rgba(9,167,212,.18), transparent 55%),
                 radial-gradient(1000px 700px at 80% 20%, rgba(84,113,183,.18), transparent 55%),
                 var(--bg); color:var(--text);}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,23,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 16px;}
    .title{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .row{display:grid;grid-template-columns: 420px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){ .row{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    .card .bd{padding:14px}
    .pill{
      font-size:12px; color: #d8ecff;
      border:1px solid rgba(9,167,212,.35);
      background: rgba(9,167,212,.12);
      padding:6px 10px;border-radius:999px;
      white-space:nowrap;
    }

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;flex-wrap:nowrap;align-items:center;margin-top:10px;}

    .btn{
      appearance:none;border:1px solid rgba(9,167,212,.35);
      background: rgba(9,167,212,.12); color:var(--text);
      padding:9px 12px;border-radius:12px; cursor:pointer;
      font-weight:600; font-size:13px;
    }
    .btn:hover{filter:brightness(1.1)}
    .input{
      width:280px; max-width:100%;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      color:var(--text); outline:none;
    }
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .drop{
      border:1px dashed rgba(138,160,182,.45);
      border-radius:14px; padding:10px 12px;
      background: rgba(255,255,255,.02);
    }
    .drop strong{color:#cfe7ff}
    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{
      text-align:left; font-weight:700;
      padding:10px 10px; color:#cfe7ff;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background: rgba(18,26,39,.85); backdrop-filter: blur(10px);
      z-index:1;
    }
    tbody td{padding:10px 10px;border-bottom:1px solid rgba(30,42,60,.7); color:#dfeaff}
    tbody tr{cursor:pointer}
    tbody tr:hover{background: rgba(9,167,212,.08)}
    tbody tr.active{background: rgba(84,113,183,.16)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

    .kpis{display:grid;grid-template-columns: repeat(3, 1fr);gap:12px}
    @media (max-width: 980px){ .kpis{grid-template-columns:1fr} }
    .kpi{border:1px solid rgba(30,42,60,.9); border-radius:14px; padding:12px; background: rgba(255,255,255,.02)}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;font-weight:800;margin-top:6px}
    .kpi .meta{margin-top:6px;color:var(--muted);font-size:12px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .badge.good{border-color:rgba(61,220,151,.35); background: rgba(61,220,151,.1); color:#c9ffe8}
    .badge.bad{border-color:rgba(255,107,107,.35); background: rgba(255,107,107,.08); color:#ffd1d1}
    .badge.warn{border-color:rgba(255,209,102,.35); background: rgba(255,209,102,.1); color:#fff1c2}

    .twoCol{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;align-items:start}
    @media (max-width: 980px){ .twoCol{grid-template-columns:1fr} }

    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
canvas{width:100% !important; height:320px !important}

    /* --- Responsive modals (iPhone-safe) --- */
    #modalOverlay{
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
    #modalBox{
      -webkit-overflow-scrolling: touch;
      width: min(860px, calc(100vw - 32px)) !important;
      max-height: calc(100vh - 32px) !important;
      overflow: hidden !important; /* keep rounded corners clean */
    }
    #modalContent{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      word-break: break-word;
      max-height: calc(100vh - 190px);
    }
    body.modalOpen{overflow:hidden;}
    @media (max-width: 520px){
      #modalOverlay{padding:12px !important;}
      #modalBox{width:calc(100vw - 24px) !important; max-height:calc(100vh - 24px) !important; border-radius:16px !important;}
      #modalContent{padding:12px !important;}
      /* Stack modal buttons on very small screens */
      #modalContent .modalActions{flex-direction:column !important; align-items:stretch !important;}
      #modalContent .modalActions .btn{width:100% !important; justify-content:center !important;}
    }
  
    /* --- Scout Mode (single-page layout switch) --- */
    #scoutPhotoBlock{display:none;}
    body.scoutMode #dashPhotoBlock{display:none !important;}
    body.scoutMode #scoutPhotoBlock{display:block !important;}

    /* Hide position controls/tooltip in Scout Mode */
    body.scoutMode #posTooltip{display:none !important;}
    body.scoutMode #posInfoBtn{display:none !important;}
    body.scoutMode #posSelect{display:none !important;}

    /* Save real estate in scout mode */
    body.scoutMode #twoColWrap{display:none !important;}
    body.scoutMode #attemptsWrap{display:none !important;}
    body.scoutMode #barsWrap{display:none !important;}


    /* --- Coach Mode: hide only Athlete Profile row, keep graphs --- */
    body.coachMode #dashPhotoBlock{display:none !important;}
    body.coachMode #scoutPhotoBlock{display:block !important;}
    body.coachMode #posTooltip{display:none !important;}
    body.coachMode #posInfoBtn{display:none !important;}
    body.coachMode #posSelect{display:none !important;}


    #search{padding-right:52px;}

    /* subtle clear search */
    #clearSearch:hover{ color:#e8f0ff; }
    #clearSearch:focus{ outline:none; }

    .avatarMissing{
      position:relative;
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 34px;
    }
    .avatarMissing:before{ content:"—"; }

    .avatarBox{ position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .avatarInitials{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      letter-spacing:.5px;
      user-select:none;
    }


/* Link-style controls (from v1.0.110 look) */
.linkBtn{
  background:transparent !important;
  border:none !important;
  padding:0 !important;
  border-radius:0 !important;
  box-shadow:none !important;
  font-weight:600;
  color:var(--muted);
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.linkBtn:hover{ color:var(--text); }
.btnIcon svg{width:13px;height:13px;flex:0 0 13px;}
.controlsSpacer{flex:1 1 auto;min-width:0px;}


.btn svg{width:13px;height:13px;vertical-align:-2px;margin-right:6px;}

.kv .k, .contactLabel{font-weight:800;}

.controlsRight{display:flex;gap:10px;align-items:center;}


/* Header height lock */
header{height:128px;min-height:128px;padding-bottom:10px;}
header .wrap.title{height:128px;align-items:flex-start;padding-top:18px;}
header .sub{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:760px;}

/* --- Mobile nav (hamburger) --- */
.menuBtn{display:none;}
.mobileTopActions{display:none;}
.navOverlay{display:none;}

@media (max-width: 820px){
  /* Let header grow on small screens */
  /*
    IMPORTANT: The drawer (.controls) lives inside <header>. Since header has a z-index,
    it creates a stacking context. If the overlay sits outside the header with a higher z-index,
    it will block clicks inside the drawer.
    Fix: raise header above the overlay, keep overlay behind, and hide the header title block
    when the drawer is open so the drawer visually overlays the header.
  */
  header{height:auto;min-height:unset;padding-bottom:8px;position:relative;z-index:2200}
  header .wrap.title{height:auto;align-items:center;padding-top:14px;gap:12px;}
  header .sub{white-space:normal;max-width:unset;}

  .menuBtn{display:inline-flex;}
  .mobileTopActions{display:flex;gap:10px;align-items:center;;position:relative;z-index:1001}

  /* Keep Refresh + Waitlist visible outside the drawer on mobile */
  .controlsRight #loadDefault,
  .controlsRight #githubBtn{display:none !important;}

  /* Turn the existing controls row into a right-side drawer */
  .controls{
    position:fixed;
    top:0;right:0;
    height:100vh;
    width:min(420px, 92vw);
    padding:16px;
    background:var(--bg);
    border-left:1px solid rgba(255,255,255,.08);
    box-shadow:-24px 0 48px rgba(0,0,0,.35);
    z-index:2300;

    display:flex;
    flex-direction:column;
    align-items:stretch;
    gap:10px;

    transform:translateX(100%);
    transition:transform .18s ease, visibility 0s linear .18s;
    visibility:hidden;
    pointer-events:none;
  }
  body.navOpen{overflow:hidden;}
  body.navOpen .controls{
    transform:translateX(0);
    transition:transform .18s ease;
    visibility:visible;
    pointer-events:auto;
  }

  .controls .controlsSpacer{display:none;}
  .controlsRight{flex-direction:column;align-items:stretch;gap:10px;}

  /* Make buttons easier to tap */
  .controls .btn, .controls .linkBtn{justify-content:flex-start;}
  .controls .searchWrap{width:100%;}
  .controls .input{width:100%;}

  #mobileMenuHeader{display:flex !important;}

  .navOverlay{
    display:block;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    z-index:2100;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
  }
  body.navOpen .navOverlay{opacity:1;pointer-events:auto;}

	  /* Allow clicks inside the drawer while letting the overlay capture taps everywhere else (including the header area) */
	  body.navOpen header{pointer-events:none;}
	  body.navOpen header .controls{pointer-events:auto;}

  /* When nav is open, hide the header title block so the drawer truly overlays the header */
  body.navOpen header .wrap.title > div:first-child{
    opacity:0;
    pointer-events:none;
  }
}


/* DEMO badge */
.demoBadge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:22px;
  padding:0 6px;
  border-radius:999px;
  font-size:10px;
  font-weight:900;
  letter-spacing:.3px;
  text-transform:uppercase;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:var(--text);
  margin-left:10px;
  transform: translateY(1px);
}

/* Athlete table mobile optimizations */
.athleteTableWrap{
  overflow-x:hidden; /* prevent sideways reveal on small screens */
}

.nameStack{display:flex;flex-direction:column;line-height:1.15}
.schoolInline{color:var(--muted);font-size:12px;margin-top:2px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

@media (max-width: 640px){
  .athleteTableWrap{ max-height: 62vh !important; }
  table{ width:100%; }
  th, td{ padding:10px 10px; font-size:13px; }
  .avatarBox{ width:32px !important; height:32px !important; border-radius:10px !important; }
  .athName{ font-size:13px; }
}

@media (max-width: 520px){
  /* Remove extra columns on phones; keep the information via inline School under the name */
  .thWeight, .thSchool, .colWeight, .colSchool{ display:none; }
  .thAge, .colAge{ width:64px; text-align:right; }
  .thName{ width:auto; }
  .schoolInline{ display:block; }
}

@media (min-width: 521px){
  /* On larger screens, keep the original 4-column look; hide the inline School to avoid duplication */
  .schoolInline{ display:none; }
}
</style>


</head>
<body>
<header>
  <div class="wrap title">
    <div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <h1 style="margin:0">Athlete Combine Dashboard <span class="small muted" style="font-weight:700;margin-left:8px">v1.0.110</span><span class="demoBadge" aria-label="Demo badge">DEMO</span></h1>
        <button type="button" class="btn linkBtn btnIcon menuBtn" id="menuOpenBtn" aria-label="Open menu" title="Menu">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <span>Menu</span>
        </button>
        <!-- Mobile-only quick actions (kept visible outside the drawer) -->
        <div class="mobileTopActions" aria-label="Quick actions">
          <button type="button" class="linkBtn btnIcon" id="mobileRefreshBtn" title="Refresh">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v6h6M20 20v-6h-6M20 8a8 8 0 00-14.9-2M4 16a8 8 0 0014.9 2"></path>
            </svg>
            <span>Refresh</span>
          </button>
          <button type="button" class="btn linkBtn btnIcon" id="mobileWaitlistBtn" title="Join the waitlist">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l9 6 9-6" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" />
            </svg>
            <span>Waitlist</span>
          </button>
        </div>
      </div>
      <div class="sub">Load your CSV → browse athletes → click an athlete to view best attempts, percentiles, and charts.</div>
    </div>

    <div class="controls" role="dialog" aria-label="Dashboard menu">
      <div style="display:none;justify-content:space-between;align-items:center;gap:10px" id="mobileMenuHeader">
        <div style="font-weight:800">Menu</div>
        <button type="button" class="btn linkBtn btnIcon" id="menuCloseBtn" aria-label="Close menu" title="Close">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          <span>Close</span>
        </button>
      </div>
      <div class="searchWrap" style="position:relative">
      <input class="input" id="search" placeholder="Search athlete name…" />
      <button type="button" class="linkBtn btnIcon" id="clearSearch" aria-label="Clear search" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:var(--muted);font-size:14px;font-weight:400;cursor:pointer;padding:0;line-height:1">x</button>
    </div>
      <button class="btn" id="toggleScout">Scout Mode: Off</button>
      <button class="btn" id="toggleCoach">Coach Mode: Off</button>
      <label class="btn" for="photos">Load Photos</label>
      <input id="photos" type="file" accept="image/*" multiple webkitdirectory style="display:none" />
      <label class="btn" for="file">Load CSV</label>
      <input id="file" type="file" accept=".csv,text/csv" style="display:none" />
      

      <div class="controlsSpacer"></div>
      <div class="controlsRight">
        <button type="button" class="linkBtn btnIcon" id="loadDefault"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
    d="M4 4v6h6M20 20v-6h-6M20 8a8 8 0 00-14.9-2M4 16a8 8 0 0014.9 2"></path>
</svg><span>Refresh</span></button>
        <button id="githubBtn" type="button" class="btn linkBtn btnIcon" title="Join the waitlist"
  onclick="openWaitlistModal()">
  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l9 6 9-6" />
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" />
  </svg>
  <span>Join the Waitlist</span>
</button>
        <button class="btn linkBtn btnIcon" id="aboutBtn" title="About" style="padding:9px 10px;border-radius:999px" type="button"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg><span>About</span></button>
        <button class="btn linkBtn btnIcon" id="versionBtn" title="Version & Changelog" style="padding:9px 10px;border-radius:999px" type="button"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
    d="M9 12h6M9 16h6M14 2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V8l-5-6z"></path>
</svg><span>Changelog</span></button>
      
      </div>
</div>
  </div>
</header>

<div class="navOverlay" id="navOverlay" aria-hidden="true"></div>

<div class="wrap">
  <div class="row">
    <!-- LEFT: Athlete list -->
    <div class="card">
      <div class="hd">
        <div>
          <div style="font-weight:800">Athletes</div>
          <div class="small" id="athleteCount">0 loaded</div>
        </div>
        <span class="pill" id="statusPill">No data</span>
      </div>
      <div class="bd">
        <div class="drop" id="dropZone">
          <div class="hint">
            <strong>Tip:</strong> Load your <span class="mono">results.csv</span> (or any CSV) and optionally load an <strong>images folder</strong> named by <span class="mono">Formulario#</span> (e.g., <span class="mono">5.jpg</span>, <span class="mono">19.png</span>).
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="athleteTableWrap" style="max-height:560px;overflow:auto;border:1px solid rgba(30,42,60,.9);border-radius:14px">
          <table>
            <thead>
              <tr>
                <th class="thName" style="width:54%">Name</th>
                <th class="thAge" style="width:10%">Age</th>
                <th class="thWeight" style="width:18%">Weight</th>
                <th class="thSchool" style="width:18%">School</th>
              </tr>
            </thead>
            <tbody id="athleteTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT: Athlete details -->
    <div class="card" id="detailCard">
      <div class="hd">
        <div>
          <div style="font-weight:800" id="athleteName">Select an athlete</div>
          <div class="small" id="athleteMeta">—</div>
        </div>
        <span class="pill" id="dataSourcePill">—</span>
      </div>

      <div class="bd">
        
        
        <div class="card" id="dashPhotoBlock" style="box-shadow:none;margin-bottom:12px">
          <div class="hd" style="background:rgba(255,255,255,.02);display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div style="font-weight:800">Athlete Profile</div>
            <div class="small muted">ID + position tag (auto-suggested)</div>
          </div>
          <div class="bd" style="display:grid;gap:10px;justify-items:center">
            <div style="width:320px;max-width:100%;position:relative">
              <!-- overlays -->
              <div id="athleteIdBadge"
                   style="position:absolute;top:10px;left:10px;z-index:2;
                          padding:8px 12px;border-radius:14px;
                          font-size:18px;font-weight:900;letter-spacing:.3px;
                          border:1px solid rgba(255,255,255,.18);
                          background:rgba(11,15,23,.55);
                          backdrop-filter: blur(8px);">
                #—
              </div>

              <div id="athletePosBadge"
                   style="position:absolute;top:10px;right:10px;z-index:2;
                          padding:8px 12px;border-radius:999px;
                          font-size:14px;font-weight:900;letter-spacing:.4px;
                          border:1px solid rgba(9,167,212,.35);
                          background:rgba(9,167,212,.18);
                          backdrop-filter: blur(8px);">
                —
              </div>

              <!-- photo -->
              <div id="athletePhotoLarge"
                   style="width:320px;height:320px;border-radius:24px;
                          overflow:hidden;border:1px solid rgba(255,255,255,.15);
                          background:rgba(255,255,255,.04)">
                <div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No photo</div>
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center">
              <span class="small muted">Position:</span>
              <select id="posSelect" class="input" style="width:220px">
                <option value="">Auto</option>
                <option>QB</option><option>RB</option><option>WR</option><option>TE</option>
                <option>OL</option><option>DL</option><option>LB</option><option>DB</option>
                <option>K/P</option>
              </select>
              <button id="posInfoBtn" class="btn" style="padding:7px 10px;border-radius:999px">?</button>
              <div id="posTooltip" style="display:none;max-width:520px;text-align:left;
                   padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
                   background:rgba(11,15,23,.75);backdrop-filter: blur(10px)">
                <div class="small muted" id="posExplain">—</div>
              </div>
            </div>
          </div>
        </div>


        
        <div class="card" id="scoutPhotoBlock" style="box-shadow:none;margin-bottom:12px">
          <div class="hd" style="background:rgba(255,255,255,.02)">
            <div style="font-weight:800">Scout Profile</div>
            <div class="small muted">Contact-ready info</div>
          </div>
          <div class="bd">
            <div class="twoCol" style="grid-template-columns: 1fr 1fr">
              <div style="position:relative;display:flex;justify-content:center">
                <div id="athletePhotoScout"
                     style="width:340px;height:340px;border-radius:24px;
                            overflow:hidden;border:1px solid rgba(255,255,255,.15);
                            background:rgba(255,255,255,.04)">
                  <div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No photo</div>
                </div>
                <div id="athleteIdBadgeScout"
                     style="position:absolute;top:12px;left:12px;z-index:2;
                            padding:8px 12px;border-radius:14px;
                            font-size:18px;font-weight:900;letter-spacing:.3px;
                            border:1px solid rgba(255,255,255,.18);
                            background:rgba(11,15,23,.55);
                            backdrop-filter: blur(8px);">
                  #—
                </div>
                <div id="athletePosBadgeScout"
                     style="position:absolute;top:12px;right:12px;z-index:2;
                            padding:8px 12px;border-radius:999px;
                            font-size:14px;font-weight:900;letter-spacing:.4px;
                            border:1px solid rgba(9,167,212,.35);
                            background:rgba(9,167,212,.18);
                            backdrop-filter: blur(8px);">
                  —
                </div>
              </div>

              <div class="contactCard">
                <div style="font-weight:800;margin-bottom:10px">Contact details</div>
                <div class="contactGrid">
                  <div class="contactItem">
                    <div class="label">DOB</div>
                    <div class="value" id="scoutDob">—</div>
                  </div>
                  <div class="contactItem">
                    <div class="label">Height</div>
                    <div class="value" id="scoutHeight">—</div>
                  </div>
                  <div class="contactItem">
                    <div class="label">Weight</div>
                    <div class="value" id="scoutWeight">—</div>
                  </div>
                  <div class="contactItem">
                    <div class="label">Phone</div>
                    <div class="value" id="scoutPhone">—</div>
                  </div>
                  <div class="contactItem" style="grid-column:1/-1">
                    <div class="label">Email</div>
                    <div class="value" id="scoutEmail">—</div>
                  </div>
                </div>
                <div class="small muted" style="margin-top:10px">
                  Tip: add an <span class="mono">Email</span> column to your CSV to populate email here.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="kpis" id="kpis"></div>

        <div style="height:12px"></div>

        <div class="twoCol" id="twoColWrap">
          <div class="card" style="box-shadow:none">
            <div class="hd" style="background:rgba(255,255,255,.02)">
              <div style="font-weight:800">Performance Radar (percentiles)</div>
              <div class="small muted">Times: lower is better • Dist/Reps: higher is better</div>
            </div>
            <div class="bd"><canvas id="radar"></canvas></div>
          </div>

          <div class="card" id="attemptsWrap" style="box-shadow:none">
            <div class="hd" style="background:rgba(255,255,255,.02)">
              <div style="font-weight:800">Attempts</div>
              <div class="small muted">Best attempt used for ranking</div>
            </div>
            <div class="bd">
              <div id="attempts"></div>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card" id="barsWrap" style="box-shadow:none">
          <div class="hd" style="background:rgba(255,255,255,.02)">
            <div style="font-weight:800">Raw Metrics (best attempt)</div>
            <div class="small muted">Quick visual of the athlete’s best values</div>
          </div>
          <div class="bd"><canvas id="bars"></canvas></div>
        </div>

        <div style="height:8px"></div>
        <div class="hint">
          <strong>Next step:</strong> After reviewing the data, shortlist your top athletes, compare them against your position benchmarks, write down follow‑up questions, and mark who you want to contact before draft day.
		</div>
      </div>
    </div>
  </div>
</div>

<script>

/** ---------- Config: map your CSV columns here ---------- **/
const COL = {
  id: "Formulario#",
  name: "Nombre",
  age: "Edad",
  dob: "Fecha de Nacimiento",
  weight: "Peso",
  height: "Estatura",
  phone: "Celular",
  address: "Direccion",
  school: "Lugar de Estudios",
  email: "Email",

  // Attempt 1:
  dash40_1: "40 YDS DASH (SEGUNDOS)",
  broad_1: "BROAD JUMP (PULGADAS)",
  shuttle_1: "5-10-5 (SHUTTLE) RUN",
  cone_1: "3- CONE DRILL",
  bench_1: "BENCHPRESS",

  // Attempt 2:
  dash40_2: "40 YDS DASH (SEGUNDOS) 2da Vuelta",
  broad_2: "BROAD JUMP (PULGADAS) 2da Vuelta",
  shuttle_2: "5-10-5 (SHUTTLE) RUN 2da Vuelta",
  cone_2: "3- CONE DRILL 2da Vuelta",
  bench_2: "BENCH PRESS 2da Vuelta",
};

// Photo CDN (Bluehost) - expects filenames like 002.jpg
const PHOTO_BASE_URL = "https://media.kkmsports.xyz/athletes/";

function padId(id){
  const s = String(id).trim();
  if (!s) return s;
  if (/^0\d+/.test(s)) return s;
  const n = Number(s);
  if (Number.isFinite(n) && n >= 0) return String(Math.trunc(n)).padStart(3, "0");
  return s;
}



const METRICS = [
  { key:"dash40", label:"40yd", unit:"s", better:"lower", a1:COL.dash40_1, a2:COL.dash40_2 },
  { key:"broad",  label:"Broad Jump", unit:"in", better:"higher", a1:COL.broad_1, a2:COL.broad_2 },
  { key:"shuttle",label:"5-10-5", unit:"s", better:"lower", a1:COL.shuttle_1, a2:COL.shuttle_2 },
  { key:"cone",   label:"3-Cone", unit:"s", better:"lower", a1:COL.cone_1, a2:COL.cone_2 },
  { key:"bench",  label:"Bench", unit:"reps", better:"higher", a1:COL.bench_1, a2:COL.bench_2 },
];

/** ---------- State ---------- **/
let rows = [];
let filtered = [];
let activeIndex = -1;
let sourceLabel = "—";

let radarChart = null;
let barChart = null;

const posOverrides = new Map(); // athleteId -> manual position

/** ---------- Photos (local folder) ---------- **/
let photoMap = new Map(); // key (Formulario#) -> objectURL

function keyFromFilename(name){
  return String(name).toLowerCase().replace(/\.[^.]+$/, "").trim();
}

function photoKeyForRow(r){
  // Match by Formulario#.
  const idRaw = String(r[COL.id] ?? "").trim();
  if (!idRaw) return "";
  // Prefer 3-digit padding to match CDN filenames like 002.jpg
  return padId(idRaw).toLowerCase();
}

function photoUrlForRow(r){
  const idRaw = String(r[COL.id] ?? "").trim();
  if (!idRaw) return null;

  // 1) Local folder photos (if loaded)
  const keyPadded = padId(idRaw).toLowerCase();
  const keyRaw = idRaw.toLowerCase();
  const local = photoMap.get(keyPadded) || photoMap.get(keyRaw);
  if (local) return local;

  // 2) CDN fallback
  if (typeof PHOTO_BASE_URL === "string" && PHOTO_BASE_URL.trim().length){
    return PHOTO_BASE_URL + padId(idRaw) + ".jpg";
  }

  return null;
}


function updateLargePhoto(r){
  const url = photoUrlForRow(r);

  const placeholder = `<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No photo</div>`;

  function fillBox(box){
    if (!box) return;
    if (!url){
      box.innerHTML = placeholder;
      return;
    }
    box.innerHTML = "";
    const img = new Image();
    img.src = url;
    img.alt = "Athlete photo";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    img.onerror = () => { box.innerHTML = placeholder; };
    box.appendChild(img);
  }

  fillBox(document.getElementById("athletePhotoLarge"));
  fillBox(document.getElementById("athletePhotoScout"));
}

/** ---------- Helpers ---------- **/
const $ = (id) => document.getElementById(id);

function toNum(v){
  if (v === null || v === undefined) return null;
  if (typeof v === "number") return Number.isFinite(v) ? v : null;
  const s = String(v).trim();
  if (!s) return null;
  const n = Number(s.replace(",", "."));
  return Number.isFinite(n) ? n : null;
}

function normalizeStr(s){
  return String(s ?? "").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function percentileRank(values, value, better){
  // values: array of numbers (non-null)
  // return 0..100 percentile (higher = better)
  if (!values.length || value === null) return null;
  const sorted = values.slice().sort((a,b)=>a-b);
  // rank position via binary search insertion index
  let lo = 0, hi = sorted.length;
  while (lo < hi){
    const mid = (lo + hi) >> 1;
    if (sorted[mid] < value) lo = mid + 1; else hi = mid;
  }
  const countLess = lo;
  const pct = (countLess / sorted.length) * 100;
  // For better=lower: invert (lower time => higher percentile)
  return better === "lower" ? (100 - pct) : pct;
}

function formatMetric(m, v){
  if (v === null) return "—";
  if (m.unit === "s") return v.toFixed(2) + " " + m.unit;
  if (m.unit === "in") return Math.round(v) + " " + m.unit;
  if (m.unit === "reps") return Math.round(v) + " " + m.unit;
  return String(v);
}

function badgeForPercentile(p){
  if (p === null) return `<span class="badge warn">No rank</span>`;
  if (p >= 75) return `<span class="badge good">Top quartile</span>`;
  if (p >= 40) return `<span class="badge warn">Mid pack</span>`;
  return `<span class="badge bad">Needs work</span>`;
}

function safe(v){ return (v === null || v === undefined || v === "") ? "—" : String(v); }

/** ---------- CSV Loading ---------- **/
function setStatus(text){
  $("statusPill").textContent = text;
}

function setSource(text){
  sourceLabel = text;
  $("dataSourcePill").textContent = text;
}

function parseCsvText(csvText, label){
  setStatus("Parsing…");
  Papa.parse(csvText, {
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      rows = (res.data || []).filter(r => normalizeStr(r[COL.name] || "").length);
      // Clean up: convert numeric metric columns to numbers
      rows.forEach(r => {
        METRICS.forEach(m => {
          r[m.a1] = toNum(r[m.a1]);
          r[m.a2] = toNum(r[m.a2]);
        });
        r[COL.age] = toNum(r[COL.age]);
        r[COL.weight] = toNum(r[COL.weight]);
      });
      setSource(label);
      setStatus("Loaded");
      render();
      // Auto-select first athlete
      if (rows.length) selectAthlete(0);
    },
    error: (err) => {
      console.error(err);
      setStatus("Error");
      alert("Could not parse CSV. Check the file format.");
    }
  });
}

async function loadDefaultCsv(){
  try{
    setStatus("Loading…");
    const res = await fetch("app/results.csv", { cache: "no-store" });
    if(!res.ok) throw new Error("results.csv not found");
    const text = await res.text();
    parseCsvText(text, "results.csv");
  }catch(e){
    console.warn(e);
    setStatus("No results.csv");
    alert("Couldn't load results.csv. Put it next to this HTML file, or use the Load CSV button.");
  }
}

/** ---------- Rendering ---------- **/
function render(){
  $("athleteCount").textContent = `${rows.length} loaded`;
  applyFilter();
}

function applyFilter(){
  const q = normalizeStr($("search").value);
  filtered = rows
    .map((r, idx) => ({ r, idx }))
    .filter(x => normalizeStr(x.r[COL.name]).includes(q))
    .sort((a,b)=> normalizeStr(a.r[COL.name]).localeCompare(normalizeStr(b.r[COL.name])));
  renderTable();
}


function initialsForRow(r){
  const full = String(r[COL.name] ?? "").trim();
  if (!full) return "—";
  const parts = full.split(/\s+/).filter(Boolean);
  const a = (parts[0] || "").slice(0,1).toUpperCase();
  const b = (parts.length>1 ? parts[parts.length-1] : "").slice(0,1).toUpperCase();
  return (a + b) || a || "—";
}

function renderTable(){
  const tb = $("athleteTable");
  tb.innerHTML = "";
  filtered.forEach((x, i) => {
    const r = x.r;
    const tr = document.createElement("tr");
    tr.dataset.idx = x.idx;
    if (x.idx === activeIndex) tr.classList.add("active");
    const url = photoUrlForRow(r);
    tr.innerHTML = `
      <td class="colName">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="avatarBox" style="width:34px;height:34px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
            ${url ? `<img class="avatarImg" data-initials="${initialsForRow(r)}" src="${url}" style="width:100%;height:100%;object-fit:cover" />` : `<div class="avatarInitials">${initialsForRow(r)}</div>`}
          </div>
          <div class="nameStack">
            <strong class="athName">${safe(r[COL.name])}</strong>
            <div class="sub schoolInline">${safe(r[COL.school])}</div>
          </div>
        </div>
      </td>
      <td class="colAge">${safe(r[COL.age])}</td>
      <td class="colWeight">${safe(r[COL.weight])}</td>
      <td class="colSchool">${safe(r[COL.school])}</td>
    `;
    tr.addEventListener("click", () => selectAthlete(x.idx));
    tb.appendChild(tr);
  });
  applyAvatarFallback();
}

function bestAttemptValue(r, m){
  const v1 = r[m.a1];
  const v2 = r[m.a2];
  if (v1 === null && v2 === null) return null;
  if (v1 === null) return v2;
  if (v2 === null) return v1;
  return (m.better === "lower") ? Math.min(v1, v2) : Math.max(v1, v2);
}

function norm01(value, min, max, invert=false){
  if (value === null || value === undefined) return null;
  const v = Math.max(min, Math.min(max, value));
  const n = (v - min) / (max - min);
  return invert ? (1 - n) : n;
}

// Simple offline "AI-like" heuristic based on combine patterns.
// Output: {pos, reason}
function suggestPosition(row){
  // pull best attempts
  const best = {};
  METRICS.forEach(m => best[m.key] = bestAttemptValue(row, m));
  const w = toNum(row[COL.weight]);
  const hStr = String(row[COL.height] ?? "").trim();

  // normalize (tuned for typical HS combine ranges; adjust later with real data)
  const speed = norm01(best.dash40, 4.4, 6.0, true);        // faster -> higher
  const explos = norm01(best.broad, 70, 130, false);        // higher -> higher
  const agility = (() => {
    const sh = norm01(best.shuttle, 3.9, 5.5, true);
    const co = norm01(best.cone, 6.5, 9.2, true);
    if (sh === null && co === null) return null;
    if (sh === null) return co;
    if (co === null) return sh;
    return (sh + co) / 2;
  })();
  const strength = norm01(best.bench, 0, 30, false);        // higher -> higher

  const heavy = (w !== null && w >= 210);
  const veryHeavy = (w !== null && w >= 250);

  // Scores per position group (very rough, but useful for an initial tag)
  const scores = {
    WR: (speed??0)*0.45 + (agility??0)*0.25 + (explos??0)*0.25 + (strength??0)*0.05,
    DB: (speed??0)*0.40 + (agility??0)*0.35 + (explos??0)*0.20 + (strength??0)*0.05,
    RB: (speed??0)*0.30 + (agility??0)*0.30 + (explos??0)*0.25 + (strength??0)*0.15,
    LB: (speed??0)*0.25 + (agility??0)*0.20 + (explos??0)*0.20 + (strength??0)*0.35 + (heavy?0.05:0),
    TE: (speed??0)*0.20 + (agility??0)*0.15 + (explos??0)*0.20 + (strength??0)*0.45 + (heavy?0.05:0),
    OL: (speed??0)*0.10 + (agility??0)*0.10 + (explos??0)*0.15 + (strength??0)*0.65 + (veryHeavy?0.10:0),
    DL: (speed??0)*0.15 + (agility??0)*0.10 + (explos??0)*0.20 + (strength??0)*0.55 + (veryHeavy?0.10:0),
    QB: (speed??0)*0.20 + (agility??0)*0.35 + (explos??0)*0.20 + (strength??0)*0.25,
    "K/P": (speed??0)*0.20 + (agility??0)*0.20 + (explos??0)*0.30 + (strength??0)*0.30
  };

  // Weight nudges
  if (veryHeavy){ scores.OL += 0.10; scores.DL += 0.08; scores.WR -= 0.08; scores.DB -= 0.08; }
  if (heavy && !veryHeavy){ scores.LB += 0.06; scores.TE += 0.05; }

  // pick best
  let bestPos = "WR", bestScore = -1;
  for (const [k,v] of Object.entries(scores)){
    if (v > bestScore){ bestScore = v; bestPos = k; }
  }

  // Build a short reason (no "real AI" claim; just heuristic)
  const parts = [];
  if (speed !== null) parts.push(`speed ${Math.round(speed*100)}`);
  if (agility !== null) parts.push(`agility ${Math.round(agility*100)}`);
  if (strength !== null) parts.push(`strength ${Math.round(strength*100)}`);
  if (explos !== null) parts.push(`explosiveness ${Math.round(explos*100)}`);
  if (w !== null) parts.push(`weight ${Math.round(w)}lb`);

  return { pos: bestPos, reason: parts.slice(0,3).join(" • ") };
}

function setPosBadge(pos, mode="auto"){
  const b = document.getElementById("athletePosBadge");
  if (!b) return;
  b.textContent = `${pos || "—"}`;
  // slight style change for manual
  if (mode === "manual"){
    b.style.borderColor = "rgba(84,113,183,.45)";
    b.style.background = "rgba(84,113,183,.22)";
  } else {
    b.style.borderColor = "rgba(9,167,212,.35)";
    b.style.background = "rgba(9,167,212,.18)";
  }
}


function computePopulationBest(m){
  const vals = [];
  rows.forEach(r => {
    const v = bestAttemptValue(r, m);
    if (v !== null) vals.push(v);
  });
  return vals;
}

function selectAthlete(originalIdx){
  activeIndex = originalIdx;
  renderTable();

  const r = rows[originalIdx];
  const photoUrl = photoUrlForRow(r);
  $("athleteName").textContent = safe(r[COL.name]);
$("athleteMeta").textContent = `Age ${safe(r[COL.age])} • ${safe(r[COL.height])} • ${safe(r[COL.weight])} lb • ${safe(r[COL.school])}`;
  updateLargePhoto(r);

  // ID badge
  const idBadge = document.getElementById("athleteIdBadge");
  const athleteId = String(r[COL.id] ?? "").trim();
  if (idBadge) idBadge.textContent = athleteId ? `#${athleteId}` : "#—";
  // Scout badges (Formulario# + suggested position)
  const idBadgeS = document.getElementById("athleteIdBadgeScout");
  if (idBadgeS) idBadgeS.textContent = athleteId ? `#${athleteId}` : "#—";

  // Suggested/selected position (reuse same logic as dashboard)
  let posValue = "—";
  try{
    const autoS = (typeof suggestPosition === "function") ? suggestPosition(r) : {pos:"—", reason:""};
    const manualS = (athleteId && typeof posOverrides !== "undefined" && posOverrides.has(athleteId)) ? posOverrides.get(athleteId) : "";
    posValue = (manualS || autoS.pos || "—");
  }catch(e){}
  const posBadgeS = document.getElementById("athletePosBadgeScout");
  if (posBadgeS) posBadgeS.textContent = posValue;

  // Scout contact details (mapped from CSV)
  const setText = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (val === null || val === undefined || String(val).trim() === "") ? "—" : String(val).trim();
  };
  setText("scoutDob", r[COL.dob]);
  setText("scoutHeight", r[COL.height]);
  setText("scoutWeight", r[COL.weight]);
  setText("scoutPhone", r[COL.phone]);
  setText("scoutEmail", r[COL.email]);



  // Position (manual override > auto)
  const sel = document.getElementById("posSelect");
  const explain = document.getElementById("posExplain");
  const manual = athleteId && posOverrides.has(athleteId) ? posOverrides.get(athleteId) : "";
  if (sel) sel.value = manual || "";
  const auto = suggestPosition(r);
  const pos = manual || auto.pos;
  setPosBadge(pos, manual ? "manual" : "auto");
  if (explain) explain.textContent = manual ? "(manual)" : `(auto: ${auto.reason})`;

  $("dataSourcePill").textContent = sourceLabel;

  // KPI cards
  const kpis = $("kpis");
  kpis.innerHTML = "";
  METRICS.forEach(m => {
    const best = bestAttemptValue(r, m);
    const pop = computePopulationBest(m);
    const p = percentileRank(pop, best, m.better);
    const el = document.createElement("div");
    el.className = "kpi";
    el.innerHTML = `
      <div class="label">${m.label}</div>
      <div class="value">${formatMetric(m, best)}</div>
      <div class="meta">Percentile: <strong>${p===null ? "—" : Math.round(p)}</strong> ${badgeForPercentile(p)}</div>
    `;
    kpis.appendChild(el);
  });

  // Attempts table
  const attempts = $("attempts");
  attempts.innerHTML = "";
  METRICS.forEach(m => {
    const v1 = r[m.a1], v2 = r[m.a2];
    const best = bestAttemptValue(r, m);
    const a1 = (v1 === null) ? "—" : formatMetric(m, v1);
    const a2 = (v2 === null) ? "—" : formatMetric(m, v2);
    const b  = (best === null) ? "—" : formatMetric(m, best);
    const used = (best === null) ? "" : (best === v1 ? "Attempt 1" : "Attempt 2");
    const box = document.createElement("div");
    box.style.marginBottom = "10px";
    box.style.padding = "10px";
    box.style.border = "1px solid rgba(30,42,60,.9)";
    box.style.borderRadius = "14px";
    box.style.background = "rgba(255,255,255,.02)";
    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div style="font-weight:800">${m.label}</div>
        <div class="small muted">${used ? "Best = " + used : ""}</div>
      </div>
      <div class="small" style="margin-top:6px">
        <div>Attempt 1: <span class="mono">${a1}</span></div>
        <div>Attempt 2: <span class="mono">${a2}</span></div>
        <div style="margin-top:6px">Best: <strong class="mono">${b}</strong></div>
      </div>
    `;
    attempts.appendChild(box);
  });

  // Charts
  renderRadar(r);
  renderBars(r);
}

function renderRadar(r){
  const labels = METRICS.map(m => m.label);
  const data = METRICS.map(m => {
    const best = bestAttemptValue(r, m);
    const pop = computePopulationBest(m);
    const p = percentileRank(pop, best, m.better);
    return p === null ? 0 : Math.max(0, Math.min(100, p));
  });

  const ctx = $("radar").getContext("2d");
  if (radarChart) radarChart.destroy();
  radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "Percentile",
        data,
        fill: true,
        borderWidth: 2,
        pointRadius: 3,
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { backdropColor: "transparent", color: "rgba(232,240,255,.75)" },
          grid: { color: "rgba(138,160,182,.22)" },
          angleLines: { color: "rgba(138,160,182,.22)" },
          pointLabels: { color: "rgba(232,240,255,.9)", font: { size: 12, weight: "Peso" } }
        }
      },
      plugins: {
        legend: { labels: { color: "rgba(232,240,255,.85)" } },
        tooltip: {
          callbacks: {
            label: (ctx) => ` ${Math.round(ctx.parsed.r)}th percentile`
          }
        }
      }
    }
  });
}

function renderBars(r){
  const labels = METRICS.map(m => `${m.label} (${m.unit})`);
  const values = METRICS.map(m => bestAttemptValue(r, m) ?? 0);

  const ctx = $("bars").getContext("2d");
  if (barChart) barChart.destroy();
  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Best attempt value",
        data: values,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "rgba(232,240,255,.85)" } },
        tooltip: {
          callbacks: {
            label: (ctx) => ` ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: { ticks: { color: "rgba(232,240,255,.85)" }, grid: { color: "rgba(138,160,182,.16)" } },
        y: { ticks: { color: "rgba(232,240,255,.85)" }, grid: { color: "rgba(138,160,182,.16)" } }
      }
    }
  });
}

/** ---------- Events ---------- **/

/** ---------- Demo gating (public showcase) ---------- **/
const IS_DEMO = true;
const WAITLIST_URL = "https://eddy0412.github.io/athlete-dashboard/jointhewaitlist.html";

function openWaitlistModal(){
  openModal("Get Early Access", `
    <div style="display:grid;gap:10px">
      <div style="font-weight:800">Unlock the full Athlete Combine Dashboard</div>
      <div class="muted">Scout Mode, Coach Mode, exports, comparisons, and contact details are available in the full version.</div>
      <div class="modalActions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <button class="btn" onclick="window.open('${WAITLIST_URL}','_blank')">Open Waitlist Page</button>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  `);
}

function openScoutDemoModal(){
  openModal("Scout Mode (Locked in Demo)", `
    <div style="display:grid;gap:10px">
      <div style="font-weight:800">This is a demo.</div>
      <div>“This is a demo. The full version unlocks Scout Mode with contact details, athlete comparison, and exports.”</div>
      <div class="modalActions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <button class="btn" onclick="window.open('${WAITLIST_URL}','_blank')">Join the Waitlist</button>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  `);
}

function openCoachDemoModal(){
  openModal("Coach Mode (Locked in Demo)", `
    <div style="display:grid;gap:10px">
      <div style="font-weight:800">This is a demo.</div>
      <div>“This is a demo. The full version unlocks Coach Mode with practice planning, performance tracking, and shareable reports for athletes and parents.”</div>
      <div class="modalActions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <button class="btn" onclick="window.open('${WAITLIST_URL}','_blank')">Join the Waitlist</button>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  `);
}

// Demo-only UI tweaks (hide admin-only controls and adjust labels)
if (IS_DEMO){
  const photoLabel = document.querySelector('label[for="photos"]');
  const csvLabel = document.querySelector('label[for="file"]');
  if (photoLabel) photoLabel.style.display = "none";
  if (csvLabel) csvLabel.style.display = "none";

  const scout = document.getElementById("toggleScout");
  const coach = document.getElementById("toggleCoach");
  if (scout) scout.textContent = "Scout Mode";
  if (coach) coach.textContent = "Coach Mode";
}

// Mobile nav (hamburger) — uses the existing header controls as a drawer on small screens
(function setupMobileNav(){
  const openBtn = document.getElementById("menuOpenBtn");
  const closeBtn = document.getElementById("menuCloseBtn");
  const overlay = document.getElementById("navOverlay");
  const mobileRefreshBtn = document.getElementById("mobileRefreshBtn");
  const mobileWaitlistBtn = document.getElementById("mobileWaitlistBtn");
  const refreshBtn = document.getElementById("loadDefault");

  function isMobile(){ return window.matchMedia && window.matchMedia("(max-width: 820px)").matches; }
  function openNav(){
    if (!isMobile()) return;
    document.body.classList.add("navOpen");
  }
  function closeNav(){
    document.body.classList.remove("navOpen");
  }

  if (openBtn) openBtn.addEventListener("click", openNav);
  if (closeBtn) closeBtn.addEventListener("click", closeNav);
  if (overlay) overlay.addEventListener("click", closeNav);

  // Mobile quick actions (outside the drawer)
  if (mobileRefreshBtn){
    mobileRefreshBtn.addEventListener("click", ()=>{
      // Trigger the existing refresh logic without duplicating code
      if (refreshBtn) refreshBtn.click();
    });
  }
  if (mobileWaitlistBtn){
    mobileWaitlistBtn.addEventListener("click", ()=>{
      if (typeof openWaitlistModal === "function") openWaitlistModal();
      else window.open(WAITLIST_URL, "_blank");
    });
  }

  window.addEventListener("resize", ()=>{
    if (!isMobile()) closeNav();
  });

  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape") closeNav();
  });
})();

// Position tooltip toggle
const posInfoBtn = document.getElementById("posInfoBtn");
const posTooltip = document.getElementById("posTooltip");
if (posInfoBtn && posTooltip){
  posInfoBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    const open = posTooltip.style.display !== "none";
    posTooltip.style.display = open ? "none" : "block";
  });
  document.addEventListener("click", ()=>{ posTooltip.style.display = "none"; });
  posTooltip.addEventListener("click", (e)=> e.stopPropagation());
}


// Manual position override (stored locally in-memory)
const posSel = document.getElementById("posSelect");
if (posSel){
  posSel.addEventListener("change", ()=>{
    if (activeIndex < 0) return;
    const r = rows[activeIndex];
    const athleteId = String(r[COL.id] ?? "").trim();
    if (!athleteId) return;

    const v = String(posSel.value ?? "").trim();
    if (!v){
      posOverrides.delete(athleteId);
    } else {
      posOverrides.set(athleteId, v);
    }

    const auto = suggestPosition(r);
    const pos = v || auto.pos;
    setPosBadge(pos, v ? "manual" : "auto");

    const explain = document.getElementById("posExplain");
    if (explain) explain.textContent = v ? "(manual)" : `(auto: ${auto.reason})`;
  });
}



$("photos").addEventListener("change", (e) => {
  photoMap.clear();
  const files = e.target.files ? Array.from(e.target.files) : [];
  for (const f of files) {
    const key = keyFromFilename(f.name);
    if (key) photoMap.set(key, URL.createObjectURL(f));
  }
  // Re-render list and refresh selected athlete
  renderTable();
  if (rows.length && activeIndex < 0) { selectAthlete(0); }
  else if (activeIndex >= 0) { selectAthlete(activeIndex); }
});

$("file").addEventListener("change", (e) => {
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => parseCsvText(reader.result, f.name);
  reader.readAsText(f);
});

$("search").addEventListener("input", applyFilter);
$("loadDefault").addEventListener("click", loadDefaultCsv);

// Drag & drop
const dz = $("dropZone");
dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.style.borderColor = "rgba(9,167,212,.8)"; });
dz.addEventListener("dragleave", ()=>{ dz.style.borderColor = "rgba(138,160,182,.45)"; });
dz.addEventListener("drop", (e)=>{
  e.preventDefault();
  dz.style.borderColor = "rgba(138,160,182,.45)";
  const f = e.dataTransfer.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => parseCsvText(reader.result, f.name);
  reader.readAsText(f);
});

// Optional: try auto-load if results.csv exists
// (works only when served via a local server; some browsers block fetch() for file://)

// Coach mode toggle (layout-only; mutually exclusive with Scout Mode)
const coachBtn = document.getElementById("toggleCoach");
function setCoachMode(on){
  document.body.classList.toggle("coachMode", !!on);
  if (coachBtn) coachBtn.textContent = `Coach Mode: ${on ? "On" : "Off"}`;
  if (on) { document.body.classList.remove("scoutMode"); if (toggleBtn) toggleBtn.textContent = "Scout Mode: Off"; }
  try{ sessionStorage.setItem("coachModeOn", on ? "1" : "0"); }catch(e){}
}
if (coachBtn){
  coachBtn.addEventListener("click", ()=>{
    if (IS_DEMO){
      openCoachDemoModal();
      return;
    }
    const on = !document.body.classList.contains("coachMode");
    setCoachMode(on);
  });
}
try{ if (!IS_DEMO) setCoachMode(sessionStorage.getItem("coachModeOn")==="1"); }catch(e){}

// Scout mode toggle (layout-only)
const toggleBtn = document.getElementById("toggleScout");
function setScoutMode(on){
  if (on) { document.body.classList.remove("coachMode"); try{ sessionStorage.setItem("coachModeOn","0"); }catch(e){} if (coachBtn) coachBtn.textContent = "Coach Mode: Off"; }

  document.body.classList.toggle("scoutMode", !!on);
  if (toggleBtn) toggleBtn.textContent = `Scout Mode: ${on ? "On" : "Off"}`;
  try{ sessionStorage.setItem("scoutModeOn", on ? "1" : "0"); }catch(e){}
}
if (toggleBtn){
  toggleBtn.addEventListener("click", ()=>{
    if (IS_DEMO){
      openScoutDemoModal();
      return;
    }
    const on = !document.body.classList.contains("scoutMode");
    setScoutMode(on);
  });
}
// restore mode
try{ if (!IS_DEMO) setScoutMode(sessionStorage.getItem("scoutModeOn")==="1"); }catch(e){}


function openModal(title, htmlContent){
  const ov = document.getElementById("modalOverlay");
  const t = document.getElementById("modalTitle");
  const c = document.getElementById("modalContent");
  if (!ov || !t || !c) return;
  // Ensure mobile drawer doesn't interfere with modal stacking on iOS
  document.body.classList.remove("navOpen");
  document.body.classList.add("modalOpen");
  t.textContent = title;
  c.innerHTML = htmlContent;
  ov.style.display = "flex";
}
function closeModal(){
  const ov = document.getElementById("modalOverlay");
  if (ov) ov.style.display = "none";
  document.body.classList.remove("modalOpen");
}




function initModalWiring(){
  const modalClose = document.getElementById("modalClose");
  const modalOverlay = document.getElementById("modalOverlay");
  const aboutBtn = document.getElementById("aboutBtn");
  const versionBtn = document.getElementById("versionBtn");

  if (modalClose) modalClose.addEventListener("click", closeModal);
  if (modalOverlay) modalOverlay.addEventListener("click", (e)=>{ if (e.target === modalOverlay) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

  if (aboutBtn){
    aboutBtn.addEventListener("click", ()=>{
      openModal("How to use this dashboard", `
        <div style="display:grid;gap:10px">
          <div><b>1) Load CSV:</b> Click <span class="mono">Choose CSV</span> and select your combine results CSV.</div>
          <div><b>2) Load photos:</b> Click <span class="mono">Load Photos</span> and select the folder containing athlete photos named by <span class="mono">Formulario#</span> (example: <span class="mono">75.jpg</span>).</div>
          <div><b>3) Browse athletes:</b> Use the left list to filter and select a player.</div>
          <div><b>4) Modes:</b>
            <ul style="margin:6px 0 0 18px">
              <li><b>Normal:</b> Full dashboard view + position suggestion controls.</li>
              <li><b>Scout Mode:</b> Scout Profile layout (contact-first).</li>
              <li><b>Coach Mode:</b> Scout Profile layout + keeps performance charts/sections below.</li>
            </ul>
          </div>
        </div>
      `);
    });
  }

  if (versionBtn){
    versionBtn.addEventListener("click", ()=>{
      openModal("Version & Changelog", `<div style="display:grid;gap:10px">
  <div style="font-weight:900">What’s new</div>
  <div><b>v1.0.110</b> — Changelog modal now includes full v1.x history (newest first).</div>

  <div style="margin-top:10px;font-weight:900">Changelog</div>

  <div style="margin-top:6px;font-weight:900">v1.0.110</div>
  <ul style="margin:6px 0 0 18px">
    <li>Added complete version history (v1.0.104 → v1.0.110) inside the Changelog modal.</li>
    <li>Kept About/Changelog modal behavior identical to the stable build.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.110</div>
  <ul style="margin:6px 0 0 18px">
    <li>Locked header height to 128px (prevents layout jumps).</li>
    <li>Improved toolbar spacing (no overlap with content).</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.108</div>
  <ul style="margin:6px 0 0 18px">
    <li>Refresh control switched to link-style to match About/Changelog group.</li>
    <li>Initial header height lock introduced (later refined in v1.0.110).</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.107</div>
  <ul style="margin:6px 0 0 18px">
    <li>controlsSpacer min-width set to 0px.</li>
    <li>“Load Photos Folder” renamed to “Load Photos”.</li>
    <li>GitHub link updated to repository URL.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.106</div>
  <ul style="margin:6px 0 0 18px">
    <li>Header right-side control order finalized: Refresh | GitHub | About | Changelog.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.105</div>
  <ul style="margin:6px 0 0 18px">
    <li>Navigation layout fixes (single-row header).</li>
    <li>GitHub button added to header controls.</li>
    <li>controlsSpacer tuned for better alignment.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v1.0.104</div>
  <ul style="margin:6px 0 0 18px">
    <li>Merged stable modal system from v8.1j-alpha with updated header link-style controls.</li>
    <li>Standardized small SVG icon sizing for header controls.</li>
  </ul>

  <div style="margin-top:6px;font-weight:900">v8.1j-alpha</div>
  <ul style="margin:6px 0 0 18px">
    <li>Baseline build with smooth working About/Changelog modals.</li>
    <li>Left list initials fallback for missing photos.</li>
  </ul>
</div>`);
    });
  }
}
document.addEventListener("DOMContentLoaded", initModalWiring);


// Search clear (X) button
const searchEl = document.getElementById("search");
const clearBtn = document.getElementById("clearSearch");
function toggleClearSearch(){
  if (!searchEl || !clearBtn) return;
  clearBtn.style.display = searchEl.value && searchEl.value.trim().length ? "inline-flex" : "none";
}
if (searchEl){
  searchEl.addEventListener("input", toggleClearSearch);
  // also show/hide on page load
  setTimeout(toggleClearSearch, 0);
}
if (clearBtn && searchEl){
  clearBtn.addEventListener("click", ()=>{
    searchEl.value = "";
    toggleClearSearch();
    // trigger existing filter logic
    searchEl.dispatchEvent(new Event("input", { bubbles:true }));
    searchEl.focus();
  });
}


function applyAvatarFallback(){
  // Replace broken avatar <img> with a subtle placeholder (no broken image icon)
  document.querySelectorAll("img.avatarImg").forEach(img=>{
    if (img.dataset.fallbackBound) return;
    img.dataset.fallbackBound = "1";
    img.addEventListener("error", ()=>{
      const ph=document.createElement("div"); ph.className="avatarInitials"; ph.textContent=img.dataset.initials||"—"; img.replaceWith(ph);
    });
  });
}

setStatus("Ready");

</script>

<!-- Modals -->
<div id="modalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:9999;align-items:center;justify-content:center;padding:18px">
  <div id="modalBox" style="width:min(860px, 96vw);max-height:86vh;overflow:auto;background:rgba(18,26,39,.98);border:1px solid rgba(30,42,60,.9);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:14px 14px;border-bottom:1px solid rgba(30,42,60,.9)">
      <div style="font-weight:900" id="modalTitle">Modal</div>
      <button class="btn" id="modalClose" style="padding:8px 10px;border-radius:12px">Close</button>
    </div>
    <div style="padding:14px" id="modalContent"></div>
  </div>
</div>

</body>
</html>
